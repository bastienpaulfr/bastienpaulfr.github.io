<!DOCTYPE html>
<html><head>
	<meta name="generator" content="Hugo 0.69.0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Bastien Paul&#39;s Blog">
    <meta name="Author" content="Bastien Paul">
    <meta name="keywords" content="hugo blog linux android java kotlin c">
    <link rel="stylesheet" href=http://bastien.famillepaul.fr/css/syntax.css>
    <link rel="stylesheet" href=http://bastien.famillepaul.fr/css/style.css>
    <script src="https://kit.fontawesome.com/1b7478c139.js" crossorigin="anonymous"></script>
    <title>Bastien Paul&#39;s Blog</title>
  </head><body><aside id="sidenav">
    <header>
    

    <a id="branding" href=http://bastien.famillepaul.fr/>
        
            Bastien Paul&#39;s Blog
        
    </a>
    </header>

    <nav>
        
            		
            <a href="/"
                
            >
                <i class="fas fa-home fa-sm"></i>
                <span>home</span>
            </a>
        
            		
            <a href="https://github.com/bastienpaulfr"
                
                    target="_blanck"
                
            >
                <i class="fab fa-github fa-ms"></i>
                <span>github</span>
            </a>
        
            		
            <a href="/contact"
                
            >
                <i class="far fa-envelope"></i>
                <span>contact</span>
            </a>
        
</aside>
<main id="main">
            <a href="javascript:void(0)" id="closebtn" onclick="navToggle()"><i class="fas fa-bars fa-lg"></i></a>
            <div class="content">
    
    <div class="section"> 
        <div class="section-title">recent</div> 
        
        
        </div>
    

    
    <div class="section"> 
        <div class="section-title">μblog</div> 
        <div class="posts">
             
            
                <div class="post">
                    
                    <div class="post-content">
                        <h1 id="add-a-new-line-at-the-end-of-each-text-files-tracked-by-git">Add a new line at the end of each text files tracked by git</h1>
<p>One of the most anoying thing I meet when I am coding software, is the « No new line at end of file » warning.</p>
<p><img src="/nl.png" alt="manifest"></p>
<p>For this, I have written a little script based of my research on google. I want to rewrite all text files tracked by git and ensure that a new line is written at the end of file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># list all files tracked by git</span>
<span style="color:#66d9ef">for</span> file in <span style="color:#e6db74">`</span>git ls-files -c -m<span style="color:#e6db74">`</span>;
<span style="color:#66d9ef">do</span>
  <span style="color:#75715e"># Test that file does exist</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -f $file <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#75715e"># Test that file is not a binary one</span>
    grep -Iq . <span style="color:#e6db74">&#34;</span>$file<span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      <span style="color:#75715e"># Add a new line</span>
      sed -i <span style="color:#e6db74">&#39;$a\&#39;</span> $file
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">done</span>
</code></pre></div><p>You can execute it from a git repository and commit the result.</p>

                    </div>
                    <div class="meta post-footer"> <span>Mar 30 2020 03:04 UTC&#43;02</span> <a href="/posts/nl-at-eof/"><i class="fas fa-link"></i> link</a></div> 
                </div>
            
                <div class="post">
                    
                    <div class="post-content">
                        <h1 id="how-to-create-a-circlular-file-logger-with-timber">How to create a circlular file logger with Timber</h1>
<p>In some applications, I need to store my logs in a file aside of traditional logcat. For this, I am making use of <a href="https://github.com/JakeWharton/timber">Timber</a> library. Because I don’t want to make my device full of logs, I wanted to use circular log files so that I can control the maximum amount of bytes taken by log data. To achieve this, I will use java Logger API to implement a new <code>Timber.Tree</code>. I also want some feature like log formatting and filtering.</p>
<p>All of this is implemented by <a href="https://github.com/bastienpaulfr/Treessence">Treessence</a> library.</p>
<h2 id="log-filtering">Log filtering</h2>
<p>To implement filtering an interface is defined :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Filter</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * @param priority Log priority.
</span><span style="color:#75715e">     * @param tag      Tag for log.
</span><span style="color:#75715e">     * @param message  Formatted log message.
</span><span style="color:#75715e">     * @param t        Accompanying exceptions.
</span><span style="color:#75715e">     * @return {@code true} if the log should be skipped, otherwise {@code false}.
</span><span style="color:#75715e">     * @see timber.log.Timber.Tree#log(int, String, String, Throwable)
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">skipLog</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> String message<span style="color:#f92672">,</span> Throwable t<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isLoggable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Priority filtering is provided by an implementation of this interface</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PriorityFilter</span> <span style="color:#66d9ef">implements</span> Filter <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> minPriority<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">PriorityFilter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> minPriority<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">minPriority</span> <span style="color:#f92672">=</span> minPriority<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">skipLog</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> String message<span style="color:#f92672">,</span> Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> priority <span style="color:#f92672">&lt;</span> minPriority<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isLoggable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> priority <span style="color:#f92672">&gt;=</span> minPriority<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getMinPriority</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> minPriority<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>We can now create our base class extending <code>Timber.DebugTree</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PriorityTree</span> <span style="color:#66d9ef">extends</span> Timber<span style="color:#f92672">.</span><span style="color:#a6e22e">DebugTree</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> PriorityFilter priorityFilter<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> Filter filter <span style="color:#f92672">=</span> NoFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * @param priority priority from witch log will be logged
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">PriorityTree</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">priorityFilter</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityFilter<span style="color:#f92672">(</span>priority<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Add additional {@link Filter}
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param f Filter
</span><span style="color:#75715e">     * @return itself
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> PriorityTree <span style="color:#a6e22e">withFilter</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NotNull</span> Filter f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">filter</span> <span style="color:#f92672">=</span> f<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isLoggable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> isLoggable<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> priority<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isLoggable</span><span style="color:#f92672">(</span>String tag<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> priority<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> priorityFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">isLoggable</span><span style="color:#f92672">(</span>priority<span style="color:#f92672">,</span> tag<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> filter<span style="color:#f92672">.</span><span style="color:#a6e22e">isLoggable</span><span style="color:#f92672">(</span>priority<span style="color:#f92672">,</span> tag<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> PriorityFilter <span style="color:#a6e22e">getPriorityFilter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> priorityFilter<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> Filter <span style="color:#a6e22e">getFilter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> filter<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Use the additional filter to determine if this log needs to be skipped
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param priority Log priority
</span><span style="color:#75715e">     * @param tag      Log tag
</span><span style="color:#75715e">     * @param message  Log message
</span><span style="color:#75715e">     * @param t        Log throwable
</span><span style="color:#75715e">     * @return true if needed to be skipped or false
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">skipLog</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> <span style="color:#a6e22e">@NotNull</span> String message<span style="color:#f92672">,</span> Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> filter<span style="color:#f92672">.</span><span style="color:#a6e22e">skipLog</span><span style="color:#f92672">(</span>priority<span style="color:#f92672">,</span> tag<span style="color:#f92672">,</span> message<span style="color:#f92672">,</span> t<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>This class can filter on two parameters :</p>
<ul>
<li>First parameter is obviously log priority. This is done thanks to PriorityFilter instance.</li>
<li>Second parameter is an additional Filter instance that can be provided by caller.</li>
</ul>
<p>## Log formatting</p>
<p>Log formatting is obtained thanks to a Formatter class whose interface is defined as follow</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Formatter</span> <span style="color:#f92672">{</span>

    String <span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> String message<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Each formatter can display log to a defined format. For instance, logcat format is <code>&quot;MM-dd HH:mm:ss:SSS {priority}/{tag}({thread id}) : {message}\n&quot;</code>. Another format would be <code>&quot;{tag} : {message}&quot;</code>.</p>
<p>Because we want to log in a file what we get in logcat, then we need to implement a logcat formatter</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LogcatFormatter</span> <span style="color:#66d9ef">implements</span> Formatter <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> LogcatFormatter INSTANCE <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LogcatFormatter<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SEP <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> HashMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> prioPrefixes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>

    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">LogcatFormatter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        prioPrefixes<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">VERBOSE</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;V/&#34;</span><span style="color:#f92672">);</span>
        prioPrefixes<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;D/&#34;</span><span style="color:#f92672">);</span>
        prioPrefixes<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">INFO</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;I/&#34;</span><span style="color:#f92672">);</span>
        prioPrefixes<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">WARN</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;W/&#34;</span><span style="color:#f92672">);</span>
        prioPrefixes<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">ERROR</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;E/&#34;</span><span style="color:#f92672">);</span>
        prioPrefixes<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">ASSERT</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;WTF/&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> <span style="color:#a6e22e">@NotNull</span> String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        String prio <span style="color:#f92672">=</span> prioPrefixes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>priority<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>prio <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            prio <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> TimeUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">timestampToDate</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;MM-dd HH:mm:ss:SSS&#34;</span><span style="color:#f92672">)</span>
               <span style="color:#f92672">+</span> SEP
               <span style="color:#f92672">+</span> prio
               <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>tag <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">:</span> tag<span style="color:#f92672">)</span>
               <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;(&#34;</span> <span style="color:#f92672">+</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) :&#34;</span>
               <span style="color:#f92672">+</span> SEP
               <span style="color:#f92672">+</span> message
               <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Priority class can then be extended to add format functionality</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Base class to format logs
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FormatterPriorityTree</span> <span style="color:#66d9ef">extends</span> PriorityTree <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> Formatter formatter <span style="color:#f92672">=</span> getDefaultFormatter<span style="color:#f92672">();</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">FormatterPriorityTree</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>priority<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Set {@link Formatter}
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param f formatter
</span><span style="color:#75715e">     * @return itself
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> FormatterPriorityTree <span style="color:#a6e22e">withFormatter</span><span style="color:#f92672">(</span>Formatter f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">formatter</span> <span style="color:#f92672">=</span> f<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Use its formatter to format log
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param priority Priority
</span><span style="color:#75715e">     * @param tag      Tag
</span><span style="color:#75715e">     * @param message  Message
</span><span style="color:#75715e">     * @return Formatted log
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> <span style="color:#a6e22e">@NotNull</span> String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> formatter<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span>priority<span style="color:#f92672">,</span> tag<span style="color:#f92672">,</span> message<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * @return Default log {@link Formatter}
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">protected</span> Formatter <span style="color:#a6e22e">getDefaultFormatter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> NoTagFormatter<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">log</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> <span style="color:#a6e22e">@NotNull</span> String message<span style="color:#f92672">,</span> Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">(</span>priority<span style="color:#f92672">,</span> tag<span style="color:#f92672">,</span> format<span style="color:#f92672">(</span>priority<span style="color:#f92672">,</span> tag<span style="color:#f92672">,</span> message<span style="color:#f92672">),</span> t<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="file-logging">File logging</h2>
<p>We have seen how to filter and format logs. We can now start logging in file.</p>
<p>For this we need a <code>java.util.logging.Logger</code> instance. It will be used in conjunction with <code>java.util.logging.FileHandler</code> that do actual file logging. We will see how to create a Logger instance later.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileLoggerTree</span> <span style="color:#66d9ef">extends</span> FormatterPriorityTree <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Logger logger<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">FileLoggerTree</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span>
                           Logger logger<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>priority<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logger</span> <span style="color:#f92672">=</span> logger<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>To activate logcat formatting by default, <code>getDefaultFormatter()</code> method is overridden</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> fr<span style="color:#f92672">.</span><span style="color:#a6e22e">bipi</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tressence</span><span style="color:#f92672">.</span><span style="color:#a6e22e">common</span><span style="color:#f92672">.</span><span style="color:#a6e22e">formatter</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Formatter</span> <span style="color:#a6e22e">getDefaultFormatter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> LogcatFormatter<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>We need to convert logcat level to <code>java.util.logging.Level</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> Level <span style="color:#a6e22e">fromPriorityToLevel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>priority<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">VERBOSE</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> Level<span style="color:#f92672">.</span><span style="color:#a6e22e">FINER</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> Level<span style="color:#f92672">.</span><span style="color:#a6e22e">FINE</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">INFO</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> Level<span style="color:#f92672">.</span><span style="color:#a6e22e">INFO</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">WARN</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> Level<span style="color:#f92672">.</span><span style="color:#a6e22e">WARNING</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">ERROR</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> Level<span style="color:#f92672">.</span><span style="color:#a6e22e">SEVERE</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">ASSERT</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> Level<span style="color:#f92672">.</span><span style="color:#a6e22e">SEVERE</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> Level<span style="color:#f92672">.</span><span style="color:#a6e22e">FINEST</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Logging is done by this method</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">log</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> priority<span style="color:#f92672">,</span> String tag<span style="color:#f92672">,</span> <span style="color:#a6e22e">@NotNull</span> String message<span style="color:#f92672">,</span> Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>skipLog<span style="color:#f92672">(</span>priority<span style="color:#f92672">,</span> tag<span style="color:#f92672">,</span> message<span style="color:#f92672">,</span> t<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    logger<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">(</span>fromPriorityToLevel<span style="color:#f92672">(</span>priority<span style="color:#f92672">),</span> format<span style="color:#f92672">(</span>priority<span style="color:#f92672">,</span> tag<span style="color:#f92672">,</span> message<span style="color:#f92672">));</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        logger<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">(</span>fromPriorityToLevel<span style="color:#f92672">(</span>priority<span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> t<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>It is logging in using <code>java.utils.logging</code> API with log level conversion and logcat formatting</p>
<p>We haven’t seen how to provide the right logger. Let see how to configure it.</p>
<p>A builder class is defined to create a FileLoggerTree instance. This builder contains some default:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Builder</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 1 mb byte of data
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> SIZE_LIMIT <span style="color:#f92672">=</span> 1048576<span style="color:#f92672">;</span>
    <span style="color:#75715e">// Max 3 files for circular logging
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> NB_FILE_LIMIT <span style="color:#f92672">=</span> 3<span style="color:#f92672">;</span>

    <span style="color:#75715e">// Base filename.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// log index will be appended so actual file name will be
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// &#34;log.0&#34; or &#34;log.1&#34;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// To parametrize where index is put, &#34;%g&#34; can be placed
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// in file name. For instance &#34;log%g.logcat&#34; will give
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// &#34;log0.logcat&#34;, &#34;log1.logcat&#34; and so on
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> String fileName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;log&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// Directory where files are stored
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> String dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// Min priority to log from
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> priority <span style="color:#f92672">=</span> Log<span style="color:#f92672">.</span><span style="color:#a6e22e">INFO</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> sizeLimit <span style="color:#f92672">=</span> SIZE_LIMIT<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> fileLimit <span style="color:#f92672">=</span> NB_FILE_LIMIT<span style="color:#f92672">;</span>
    <span style="color:#75715e">// append log to already existing log file
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> appendToFile <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

<span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>java.util.logging.Logger</code> are created and managed by <code>java.util.logging.LogManager</code>. To bypass this a simple static class is used</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Custom logger class that has no references to LogManager
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyLogger</span> <span style="color:#66d9ef">extends</span> Logger <span style="color:#f92672">{</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Constructs a {@code Logger} object with the supplied name and resource
</span><span style="color:#75715e">     * bundle name; {@code notifyParentHandlers} is set to {@code true}.
</span><span style="color:#75715e">     * &lt;p/&gt;
</span><span style="color:#75715e">* Notice : Loggers use a naming hierarchy. Thus &#34;z.x.y&#34; is a child of &#34;z.x&#34;.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param name the name of this logger, may be {@code null} for anonymous
</span><span style="color:#75715e">     *             loggers.
</span><span style="color:#75715e">     */</span>
    MyLogger<span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Logger <span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> MyLogger<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Creation of <code>java.util.logging.Logger</code> can start</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> FileLoggerTree <span style="color:#a6e22e">build</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
  <span style="color:#75715e">// Log file path
</span><span style="color:#75715e"></span>  String path <span style="color:#f92672">=</span> FileUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">combinePath</span><span style="color:#f92672">(</span>dir<span style="color:#f92672">,</span> fileName<span style="color:#f92672">);</span>
  <span style="color:#75715e">// File handler that is performing file logging
</span><span style="color:#75715e"></span>  FileHandler fileHandler<span style="color:#f92672">;</span>
  <span style="color:#75715e">// Our custom logger
</span><span style="color:#75715e"></span>  Logger logger <span style="color:#f92672">=</span> MyLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">);</span>
  <span style="color:#75715e">// We force level to ALL because priority filtering is
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// done by our Tree implementation
</span><span style="color:#75715e"></span>  logger<span style="color:#f92672">.</span><span style="color:#a6e22e">setLevel</span><span style="color:#f92672">(</span>Level<span style="color:#f92672">.</span><span style="color:#a6e22e">ALL</span><span style="color:#f92672">);</span>
  <span style="color:#75715e">// File handler can now be created
</span><span style="color:#75715e"></span>  fileHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileHandler<span style="color:#f92672">(</span>path<span style="color:#f92672">,</span> sizeLimit<span style="color:#f92672">,</span> fileLimit<span style="color:#f92672">,</span>  appendToFile<span style="color:#f92672">);</span>
  <span style="color:#75715e">// Formating is done by our Tree implementation
</span><span style="color:#75715e"></span>  fileHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">setFormatter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> NoFormatter<span style="color:#f92672">());</span>
  <span style="color:#75715e">// Configure java Logger
</span><span style="color:#75715e"></span>  logger<span style="color:#f92672">.</span><span style="color:#a6e22e">addHandler</span><span style="color:#f92672">(</span>fileHandler<span style="color:#f92672">);</span>
  <span style="color:#75715e">// finally we got here !
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> FileLoggerTree<span style="color:#f92672">(</span>priority<span style="color:#f92672">,</span> logger<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Full code of <code>FileLoggerTree</code> is <a href="https://github.com/bastienpaulfr/Treessence/blob/master/treessence/src/main/java/fr/bipi/tressence/file/FileLoggerTree.java">here</a></p>
<p>This tree can then be planted like this</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">FileLoggerTree fileTree <span style="color:#f92672">=</span> FileLoggerTree<span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">()</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">withFileName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;log%g.logcat&#34;</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">withMinPriority</span><span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">VERBOSE</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">()</span>
Timber<span style="color:#f92672">.</span><span style="color:#a6e22e">plant</span><span style="color:#f92672">(</span>fileTree<span style="color:#f92672">)</span>
</code></pre></div><p>Thanks for reading this. Full source code is available <a href="https://github.com/bastienpaulfr/Treessence">here</a></p>

                    </div>
                    <div class="meta post-footer"> <span>Mar 1 2019 03:04 UTC&#43;02</span> <a href="/posts/circular-file-logger/"><i class="fas fa-link"></i> link</a></div> 
                </div>
            
                <div class="post">
                    
                    <div class="post-content">
                        <h1 id="publish-a-kotlin-lib-with-gradle-kotlin-dsl">Publish a Kotlin lib with gradle Kotlin DSL</h1>
<p>I wanted to play more with Kotlin and I wanted to publish <a href="https://github.com/bastienpaulfr/geojson-kotlin">KGeoGson</a> lib to a remote maven repo.</p>
<p>I was following <a href="https://guides.gradle.org/building-kotlin-jvm-libraries/">gradle guide</a> to build my kotlin project with Kotlin DSL.</p>
<h2 id="bootstrap-kotlin-project">Bootstrap Kotlin project</h2>
<p>Create project directory with files of your library you want to build and publish. You may have a directory structure like the following:</p>
<pre><code>project
├── build.gradle.kts
├── settings.gradle.kts
└── my-kotlin-library
    ├── build.gradle.kts
    └── src
        ├── main
        │   └── kotlin
        │       └── org
        │           └── example
        │               └── MyLibrary.kt
        └── test
            └── kotlin
                └── org
                    └── example
                        └── MyLibraryTest.kt
</code></pre><h2 id="setup">Setup</h2>
<p>Root <strong>build.gradle.kts</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">plugins {
   <span style="color:#960050;background-color:#1e0010">`</span>build-scan<span style="color:#960050;background-color:#1e0010">`</span>
}

buildScan {
   termsOfServiceUrl = <span style="color:#e6db74">&#34;https://gradle.com/terms-of-service&#34;</span>
   termsOfServiceAgree = <span style="color:#e6db74">&#34;yes&#34;</span>

   publishAlways()
}

<span style="color:#66d9ef">val</span> clean <span style="color:#66d9ef">by</span> tasks.creating(Delete<span style="color:#f92672">::</span><span style="color:#66d9ef">class</span>) {
   delete(rootProject.buildDir)
}
</code></pre></div><p>In this file, « build-scan » plugin is activated and a clean task is added. That’s all for it</p>
<p><strong>settings.gradle.kts</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">include(<span style="color:#e6db74">&#34;lib&#34;</span>)
</code></pre></div><p>In this file, we define our modules</p>
<p><strong>lib/build.gradle.kts</strong></p>
<p>First we are adding some plugins</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">plugins {
   <span style="color:#75715e">// Add Kotlin plugin to build our Kotlin lib
</span><span style="color:#75715e"></span>   kotlin(<span style="color:#e6db74">&#34;jvm&#34;</span>) version <span style="color:#e6db74">&#34;1.3.21&#34;</span>
   <span style="color:#75715e">// Get version from git tags
</span><span style="color:#75715e"></span>   id(<span style="color:#e6db74">&#34;fr.coppernic.versioning&#34;</span>) version <span style="color:#e6db74">&#34;3.1.2&#34;</span>
   <span style="color:#75715e">// Documentation for our code
</span><span style="color:#75715e"></span>   id(<span style="color:#e6db74">&#34;org.jetbrains.dokka&#34;</span>) version <span style="color:#e6db74">&#34;0.9.17&#34;</span>
   <span style="color:#75715e">// Publication to bintray
</span><span style="color:#75715e"></span>   id(<span style="color:#e6db74">&#34;com.jfrog.bintray&#34;</span>) version <span style="color:#e6db74">&#34;1.8.4&#34;</span>
   <span style="color:#75715e">// Maven publication
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">`</span>maven-publish<span style="color:#960050;background-color:#1e0010">`</span>
}
</code></pre></div><p>Then we are defining dependencies and their repositories for our code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">repositories {
   jcenter()
   mavenCentral()
}

dependencies {
   implementation(<span style="color:#e6db74">&#34;org.jetbrains.kotlin:kotlin-stdlib-jdk7&#34;</span>)
   implementation(<span style="color:#e6db74">&#34;com.google.code.gson:gson:2.8.5&#34;</span>)

   testCompile(<span style="color:#e6db74">&#34;junit:junit:4.12&#34;</span>)
}
</code></pre></div><p>We need some more tasks to add sources and javadoc to our lib. We are starting by configuring dokka task:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">tasks {
   dokka {
       outputFormat = <span style="color:#e6db74">&#34;html&#34;</span>
       outputDirectory = <span style="color:#e6db74">&#34;$buildDir/javadoc&#34;</span>
       moduleName = rootProject.name
   }
}
</code></pre></div><p>We can then bundle documentation into a jar</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">val</span> dokkaJar <span style="color:#66d9ef">by</span> tasks.creating(Jar<span style="color:#f92672">::</span><span style="color:#66d9ef">class</span>) {
   group = JavaBasePlugin.DOCUMENTATION_GROUP
   description = <span style="color:#e6db74">&#34;Assembles Kotlin docs with Dokka&#34;</span>
   archiveClassifier.<span style="color:#66d9ef">set</span>(<span style="color:#e6db74">&#34;javadoc&#34;</span>)
   from(tasks.dokka)
   dependsOn(tasks.dokka)
}
</code></pre></div><p>We are creating another jar containing sources</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">val</span> sourcesJar <span style="color:#66d9ef">by</span> tasks.creating(Jar<span style="color:#f92672">::</span><span style="color:#66d9ef">class</span>) {
   archiveClassifier.<span style="color:#66d9ef">set</span>(<span style="color:#e6db74">&#34;sources&#34;</span>)
   from(sourceSets.getByName(<span style="color:#e6db74">&#34;main&#34;</span>).allSource)
}
</code></pre></div><p>At this stage, you are able to compile your lib. The most important part of this article begins. Let’s see how publication is working. It is very important to configure pom.xml file of maven artifact in a right manner. Otherwise you will not be able to submit your library into JCenter repo.</p>
<p>Let’s start configuring base of maven publish plugin</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">val</span> artifactName = <span style="color:#e6db74">&#34;libname&#34;</span>
<span style="color:#66d9ef">val</span> artifactGroup = <span style="color:#e6db74">&#34;org.example&#34;</span>

publishing {
   publications {
       create&lt;MavenPublication&gt;(<span style="color:#e6db74">&#34;lib&#34;</span>) {
           groupId = artifactGroup
           artifactId = artifactName
           <span style="color:#75715e">// version is gotten from an external plugin
</span><span style="color:#75715e"></span>           version = project.versioning.info.display
           <span style="color:#75715e">// This is the main artifact
</span><span style="color:#75715e"></span>           from(components[<span style="color:#e6db74">&#34;java&#34;</span>])
           <span style="color:#75715e">// We are adding documentation artifact
</span><span style="color:#75715e"></span>           artifact(dokkaJar)
           <span style="color:#75715e">// And sources
</span><span style="color:#75715e"></span>           artifact(sourcesJar)
       }
   }
}
</code></pre></div><p>Now we need to add information about package in <strong>pom.xml</strong> file. You can edit <strong>pom.xml</strong> with <code>pom.withXml {</code> code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">val</span> pomUrl = <span style="color:#e6db74">&#34;...&#34;</span>
<span style="color:#66d9ef">val</span> pomScmUrl = <span style="color:#e6db74">&#34;...&#34;</span>
<span style="color:#66d9ef">val</span> pomIssueUrl = <span style="color:#e6db74">&#34;...&#34;</span>
<span style="color:#66d9ef">val</span> pomDesc = <span style="color:#e6db74">&#34;...&#34;</span>
<span style="color:#66d9ef">val</span> pomScmConnection = <span style="color:#e6db74">&#34;&#34;</span>...<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74"></span><span style="color:#66d9ef">val</span> pomScmDevConnection = <span style="color:#e6db74">&#34;...&#34;</span>

<span style="color:#66d9ef">val</span> githubRepo = <span style="color:#e6db74">&#34;...&#34;</span>
<span style="color:#66d9ef">val</span> githubReadme = <span style="color:#e6db74">&#34;...&#34;</span>

<span style="color:#66d9ef">val</span> pomLicenseName = <span style="color:#e6db74">&#34;The Apache Software License, Version 2.0&#34;</span>
<span style="color:#66d9ef">val</span> pomLicenseUrl = <span style="color:#e6db74">&#34;http://www.apache.org/licenses/LICENSE-2.0.txt&#34;</span>
<span style="color:#66d9ef">val</span> pomLicenseDist = <span style="color:#e6db74">&#34;repo&#34;</span>

<span style="color:#66d9ef">val</span> pomDeveloperId = <span style="color:#e6db74">&#34;...&#34;</span>
<span style="color:#66d9ef">val</span> pomDeveloperName = <span style="color:#e6db74">&#34;...&#34;</span>


publishing {
   publications {
       create&lt;MavenPublication&gt;(<span style="color:#e6db74">&#34;lib&#34;</span>) {
<span style="color:#a6e22e">           [...]</span>

           pom.withXml {
               asNode().apply {
                   appendNode(<span style="color:#e6db74">&#34;description&#34;</span>, pomDesc)
                   appendNode(<span style="color:#e6db74">&#34;name&#34;</span>, rootProject.name)
                   appendNode(<span style="color:#e6db74">&#34;url&#34;</span>, pomUrl)
                   appendNode(<span style="color:#e6db74">&#34;licenses&#34;</span>).appendNode(<span style="color:#e6db74">&#34;license&#34;</span>).apply {
                       appendNode(<span style="color:#e6db74">&#34;name&#34;</span>, pomLicenseName)
                       appendNode(<span style="color:#e6db74">&#34;url&#34;</span>, pomLicenseUrl)
                       appendNode(<span style="color:#e6db74">&#34;distribution&#34;</span>, pomLicenseDist)
                   }
                   appendNode(<span style="color:#e6db74">&#34;developers&#34;</span>).appendNode(<span style="color:#e6db74">&#34;developer&#34;</span>).apply {
                       appendNode(<span style="color:#e6db74">&#34;id&#34;</span>, pomDeveloperId)
                       appendNode(<span style="color:#e6db74">&#34;name&#34;</span>, pomDeveloperName)
                   }
                   appendNode(<span style="color:#e6db74">&#34;scm&#34;</span>).apply {
                       appendNode(<span style="color:#e6db74">&#34;url&#34;</span>, pomScmUrl)
                       appendNode(<span style="color:#e6db74">&#34;connection&#34;</span>, pomScmConnection)
                   }
               }
           }
       }
   }
}
</code></pre></div><p>Now that your maven publication is well configured, you can configure bintray plugin</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">bintray {
   <span style="color:#75715e">// Getting bintray user and key from properties file or command line
</span><span style="color:#75715e"></span>   user = <span style="color:#66d9ef">if</span> (project.hasProperty(<span style="color:#e6db74">&#34;bintray_user&#34;</span>)) project.property(<span style="color:#e6db74">&#34;bintray_user&#34;</span>) <span style="color:#66d9ef">as</span> String <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;&#34;</span>
   key = <span style="color:#66d9ef">if</span> (project.hasProperty(<span style="color:#e6db74">&#34;bintray_key&#34;</span>)) project.property(<span style="color:#e6db74">&#34;bintray_key&#34;</span>) <span style="color:#66d9ef">as</span> String <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;&#34;</span>

   <span style="color:#75715e">// Automatic publication enabled
</span><span style="color:#75715e"></span>   publish = <span style="color:#66d9ef">true</span>

   <span style="color:#75715e">// Set maven publication onto bintray plugin
</span><span style="color:#75715e"></span>   setPublications(<span style="color:#e6db74">&#34;lib&#34;</span>)

   <span style="color:#75715e">// Configure package
</span><span style="color:#75715e"></span>   pkg.apply {
       repo = <span style="color:#e6db74">&#34;maven&#34;</span>
       name = rootProject.name
       setLicenses(<span style="color:#e6db74">&#34;Apache-2.0&#34;</span>)
       setLabels(<span style="color:#e6db74">&#34;Gson&#34;</span>, <span style="color:#e6db74">&#34;json&#34;</span>, <span style="color:#e6db74">&#34;GeoJson&#34;</span>, <span style="color:#e6db74">&#34;GPS&#34;</span>, <span style="color:#e6db74">&#34;Kotlin&#34;</span>)
       vcsUrl = pomScmUrl
       websiteUrl = pomUrl
       issueTrackerUrl = pomIssueUrl
       githubRepo = githubRepo
       githubReleaseNotesFile = githubReadme

       <span style="color:#75715e">// Configure version
</span><span style="color:#75715e"></span>       version.apply {
           name = project.versioning.info.display
           desc = pomDesc
           released = Date().toString()
           vcsTag = project.versioning.info.tag
       }
   }
}
</code></pre></div><p>Here we is ! Happy publication !</p>

                    </div>
                    <div class="meta post-footer"> <span>Feb 8 2019 03:03 UTC&#43;02</span> <a href="/posts/publish-kotlin-lib/"><i class="fas fa-link"></i> link</a></div> 
                </div>
            
                <div class="post">
                    
                    <div class="post-content">
                        <h1 id="use-dagger-provider-with-android-material-stepper">Use Dagger Provider with Android Material Stepper</h1>
<p>On an Android project, I am using <a href="https://github.com/stepstone-tech/android-material-stepper">android-material-stepper</a> from StepStone. I am also using dependency injection with <a href="https://google.github.io/dagger/">dagger</a>.</p>
<p>I was facing the following problem : How to properly inject <code>Fragments</code> without the need to create a <code>DaggerComponent</code> for each of them ?</p>
<p>Providers are here to help. This is how I am doing</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StepFragmentBL</span> @Inject <span style="color:#66d9ef">constructor</span>() :
 Fragment(), Step, BlView {

    @Inject
    <span style="color:#66d9ef">lateinit</span> <span style="color:#66d9ef">var</span> blPresenter: BlPresenter

    ...
}
</code></pre></div><p>This is one of the Fragment I am creating. We can see the <code>@Inject constructor</code> with <code>@Inject lateinit</code> var that shows that this object is injectable by dagger. It is also implementing <code>Step</code> to be used by <code>StepperLayout</code> and implements another interface.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BlPresenter</span> @Inject <span style="color:#66d9ef">constructor</span>

BlPresenter <span style="color:#66d9ef">is</span> a simple injectable <span style="color:#66d9ef">class</span>

<span style="color:#a6e22e">@Singleton</span>
@Component(modules = [(DeliveryModule<span style="color:#f92672">::</span><span style="color:#66d9ef">class</span>)])
<span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">DeliveryComponents</span> {

    <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">inject</span>(deliveryActivity: DeliveryActivity)
}
</code></pre></div><p>This is the component injecting my Activity</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">@Module
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeliveryModule</span>(<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> activity: DeliveryActivity) {

    @Named(<span style="color:#e6db74">&#34;Activity&#34;</span>)
    @Provides
    <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">providesContext</span>(): Context {
        <span style="color:#66d9ef">return</span> activity
    }

    @Provides
    <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">providesFragmentManager</span>(): FragmentManager {
        <span style="color:#66d9ef">return</span> activity.supportFragmentManager
    }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeliveryActivity</span> : AppCompatActivity() {

    @Inject
    <span style="color:#66d9ef">lateinit</span> <span style="color:#66d9ef">var</span> deliveryPresenter: DeliveryPresenter

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">lateinit</span> <span style="color:#66d9ef">var</span> deliveryComponents: DeliveryComponents

    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">onCreate</span>(savedInstanceState: Bundle?) {
        <span style="color:#66d9ef">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_home)

        di()
        ui()
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">di</span>() {
        deliveryComponents = DaggerDeliveryComponents.builder()
                .deliveryModule(DeliveryModule(<span style="color:#66d9ef">this</span>))
                .build()
        deliveryComponents.inject(<span style="color:#66d9ef">this</span>)
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">ui</span>() {
        Timber.v(Info.getMethodName())
        stepperLayout.adapter = deliveryPresenter.stepperAdapter
    }
}
</code></pre></div><p>We are creating the component into the <code>Activity</code> here. Then, presenter for this activity is also injected</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeliveryPresenter</span> @Inject <span style="color:#66d9ef">constructor</span>() {

    @Inject
    <span style="color:#66d9ef">lateinit</span> <span style="color:#66d9ef">var</span> stepperAdapter: PickingStepperAdapter

}
</code></pre></div><p>We are arriving to a <code>StepperAdapter</code> instance, also injected</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">val</span> NB_FRAG = <span style="color:#ae81ff">2</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PickingStepperAdapter</span> @Inject <span style="color:#66d9ef">constructor</span>(
        fm: FragmentManager,
        @Named(<span style="color:#e6db74">&#34;Activity&#34;</span>) context: Context) :
            AbstractFragmentStepAdapter(fm, context) {

    <span style="color:#75715e">/**
</span><span style="color:#75715e">    * Provider for Fragment
</span><span style="color:#75715e">    */</span>
    @Inject
    <span style="color:#66d9ef">lateinit</span> <span style="color:#66d9ef">var</span> blFragmentProvider: Provider&lt;StepFragmentBL&gt;

    <span style="color:#75715e">/**
</span><span style="color:#75715e">    * Provider for Fragment
</span><span style="color:#75715e">    */</span>
    @Inject
    <span style="color:#66d9ef">lateinit</span> <span style="color:#66d9ef">var</span> pdtFragmentProvider: Provider&lt;StepFragmentPdt&gt;

    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">getCount</span>(): Int {
        <span style="color:#66d9ef">return</span> NB_FRAG
    }

    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">createStep</span>(position: Int): Step {
        Timber.v(<span style="color:#e6db74">&#34;${Info.getMethodName()} $position&#34;</span>)

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">when</span> (position) {
            <span style="color:#ae81ff">0</span> -&gt; blFragmentProvider.<span style="color:#66d9ef">get</span>()
            <span style="color:#66d9ef">else</span> -&gt; pdtFragmentProvider.<span style="color:#66d9ef">get</span>()
        }
    }
}
</code></pre></div><p>Here, we are just using</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">@Inject
    <span style="color:#66d9ef">lateinit</span> <span style="color:#66d9ef">var</span> blFragmentProvider: Provider&lt;StepFragmentBL&gt;
</code></pre></div><p>to tell dagger to create the code that will provide an instance of fragment each time <code>blFragmentProvider.get()</code> will be called. Indeed, this is called here</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">return</span> <span style="color:#66d9ef">when</span> (position) {
            <span style="color:#ae81ff">0</span> -&gt; blFragmentProvider.<span style="color:#66d9ef">get</span>()
            <span style="color:#66d9ef">else</span> -&gt; pdtFragmentProvider.<span style="color:#66d9ef">get</span>()
        }
</code></pre></div><p>Like this, dagger is injecting fragment for us, and we don’t have to care about objects creation</p>

                    </div>
                    <div class="meta post-footer"> <span>Jan 24 2019 03:03 UTC&#43;02</span> <a href="/posts/dagger-material-stepper/"><i class="fas fa-link"></i> link</a></div> 
                </div>
            
                <div class="post">
                    
                    <div class="post-content">
                        <p># Android : Créer un fichier keystore (jks) à partir d’une clé (.pk8) et d’un certificat (.pem)</p>
<ul>
<li>Extraire la clé contenue dans le fichier pk8 et la mettre en clair dans un fichier pem</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">openssl pkcs8 -inform DER -nocrypt -in key.pk8 -out key.pem
</code></pre></div><ul>
<li>Regrouper la clé et le certificat dans un fichier p12 temporaire</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">openssl pkcs12 -export -in certificate.pem -inkey key.pem -out platform.p12 -password pass:android -name AndroidDebugKey
</code></pre></div><ul>
<li>Générer le fichier jks à partir du p12 (keytool est un outil du framework android)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">keytool -importkeystore -deststorepass android -destkeystore platform.jks -srckeystore platform.p12 -srcstoretype PKCS12 -srcstorepass android
</code></pre></div><ul>
<li>Vérifier le fichier</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">keytool -list -v -keystore platform.jks
</code></pre></div>
                    </div>
                    <div class="meta post-footer"> <span>Nov 14 2016 03:03 UTC&#43;02</span> <a href="/posts/from-pk8-to-jks/"><i class="fas fa-link"></i> link</a></div> 
                </div>
            
                <div class="post">
                    
                    <div class="post-content">
                        <h1 id="protéger-les-classes-contre-la-copie-ou-lassignation-en-c">Protéger les classes contre la copie ou l’assignation en C++</h1>
<p>Pour protéger les classes contre la copie, il suffit de déclarer le constructeurs de copie en <code>private</code>. Une macro peut être définie car le principe est le même pour toutes les classes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">#define DECLARE_NO_COPY_CLASS(classname)  
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>                              
        classname(<span style="color:#66d9ef">const</span> classname<span style="color:#f92672">&amp;</span>);
<span style="color:#75715e">#endif
</span></code></pre></div><p>De même pour les protéger contre l’assignation, on peut déclarer la surcharge de l’opérateur <code>=</code> comme étant <code>private</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">#define DECLARE_NO_ASSIGN_CLASS(classname)  
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>                                
        classname<span style="color:#f92672">&amp;</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">=</span>(<span style="color:#66d9ef">const</span> classname<span style="color:#f92672">&amp;</span>);
<span style="color:#75715e">#endif
</span></code></pre></div>
                    </div>
                    <div class="meta post-footer"> <span>Aug 14 2014 03:02 UTC&#43;02</span> <a href="/posts/assignation-protect/"><i class="fas fa-link"></i> link</a></div> 
                </div>
            
                <div class="post">
                    
                    <div class="post-content">
                        <h1 id="assert-statique">Assert Statique</h1>
<p>L’utilisation d’un assert statique peut être utile dans le cas ou une condition doit être testée au moment de la compilation. Par exemple la taille d’un tableau. Le principe est d’utiliser une macro pour définir une expression. Si le test est valide alors l’expression générée l’est aussi, sinon elle résulte en une erreur de compilation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">#define STATIC_ASSERT(cond)    typedef int ERROR_##__LINE__[(cond) ? 1 : -1]
</span></code></pre></div><p>Ici, on utilise <code>typedef</code> pour définir un type tableau. Si la condition est valide alors la taille du tableau est positive. Sinon elle est négative ce qui résulte en une erreur de compilation.</p>
<p>Exemple d’utilisation :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">STATIC_ASSERT(<span style="color:#66d9ef">sizeof</span>(object1) <span style="color:#f92672">==</span> <span style="color:#66d9ef">sizeof</span>(object2));
</code></pre></div>
                    </div>
                    <div class="meta post-footer"> <span>Aug 4 2014 03:02 UTC&#43;02</span> <a href="/posts/static-assert/"><i class="fas fa-link"></i> link</a></div> 
                </div>
            
                <div class="post">
                    
                    <div class="post-content">
                        <h1 id="mutex-locker">Mutex Locker</h1>
<h2 id="préambule">Préambule</h2>
<p>Le mutex locker fait partie du concept de <a href="http://fr.wikipedia.org/wiki/RAII">RAII</a>. Cette acronyme vient de l’anglais Resource Acquisition Is Initialization. C’est une technique de programmation qui permet de s’assurer que la ressource acquise sera bien libérée à la fin de la vie d’un objet.</p>
<h2 id="principe">Principe</h2>
<p>Appliqué au mutex, ce principe consiste à bloquer un mutex lors de la création d’un objet et de le libérer lors de sa destruction. On peut imaginer la création d’un objet spécifique : le <code>MutexLocker</code>.  Il faudrait qu’il puisse prendre un mutex lors de sa création et le libérer lors de sa destruction. Son constructeur va donc prendre le mutex et son destructeur le détruire.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MutexLocker</span> {
    <span style="color:#66d9ef">public</span> <span style="color:#f92672">:</span>
        MutexLocker(Mutex<span style="color:#f92672">&amp;</span> mutex)<span style="color:#f92672">:</span> m_mutex(mutex) {
            m_mutex.Lock();
        }
        <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>MutexLocker(){
            m_mutex.Unlock();
        }

    <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
        Mutex<span style="color:#f92672">&amp;</span> m_mutex;
};
</code></pre></div><p>Son utilisation procède comme suit :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">{
    Mutex mutex;
    MutexLocker <span style="color:#a6e22e">locker</span>(mutex);
    <span style="color:#75715e">/* Maintenant le mutex est pris. Le code critique peut être exécuté. */</span>
}
</code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Son utilisation est justifié quand des exceptions peuvent arriver à tout moment. A ce moment, le mutex est assuré d’être libéré à la fin de la portée du code lorsque le locker est détruit. D’une manière générale, il est bon de l’utiliser tout le temps pour éviter de tomber dans des cas d’erreur difficiles à détecter.</p>

                    </div>
                    <div class="meta post-footer"> <span>Aug 4 2014 03:02 UTC&#43;02</span> <a href="/posts/mutex-locker/"><i class="fas fa-link"></i> link</a></div> 
                </div>
            
                <div class="post">
                    
                    <div class="post-content">
                        <h1 id="singleton">Singleton</h1>
<h2 id="présentation">Présentation</h2>
<p>Le singleton est un patron de conception (design pattern) dont le but est de restreindre l’instanciation  d’une classe à un nombre défini d’objets. Il est utilisé lorsque l’on a besoin que d’un seul objet pour coordonner des actions dans un système. Par exemple, le singleton va être utilisé comme gestionnaire de fenêtre, gestionnaire de systèmes de fichiers ou d’imprimantes. Le singleton va être disponible de manière globale dans un package et sera utilisé comme étant un point d’accès.</p>
<p>Le singleton est une classe qui va s’instancier elle-même. Ses constructeurs seront donc définis comme étant privés. Elle met à disposition une méthode statique pour récupérer son instance. Cette méthode vérifie qu’une seule instance existe ou en crée une si elle n’existe pas encore.</p>
<p>Une attention particulière sera donnée dans les environnements multi-threadés. Si deux thread essaient d’accéder à l’objet, un seul devra l’instancier tandis que le deuxième obtiendra une référence sur l’objet nouvellement créé.</p>
<h2 id="implémentation-en-c">Implémentation en C++</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singleton</span>
{
    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">static</span> T<span style="color:#f92672">*</span> Get() {
            <span style="color:#66d9ef">if</span>(null <span style="color:#f92672">==</span> m_intance) {
                m_instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> T;
            }
            <span style="color:#66d9ef">return</span> m_instance;
        }

    <span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
        Singleton(){};
        <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>Singleton(){};

    <span style="color:#66d9ef">private</span> <span style="color:#f92672">:</span>
        <span style="color:#66d9ef">static</span> T<span style="color:#f92672">*</span> m_instance;
};
</code></pre></div><p>Les classes peuvent ensuite hériter de <code>Singleton</code>. Elles seront instanciées par la méthode héritée <code>Get()</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">lass Eur : <span style="color:#66d9ef">public</span> Singleton<span style="color:#f92672">&lt;</span>Eur<span style="color:#f92672">&gt;</span>
{
    <span style="color:#66d9ef">friend</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singleton</span><span style="color:#f92672">&lt;</span>Eur<span style="color:#f92672">&gt;</span>;
};

func(){
    Eur<span style="color:#f92672">*</span> obj <span style="color:#f92672">=</span> Eur<span style="color:#f92672">::</span>Get();
};
</code></pre></div><h2 id="multi-threading">Multi-Threading</h2>
<p>Dans un environnement multi-tâche,  il est important de protéger le code d’instanciation pour éviter d’avoir plusieurs références vers le Singleton lorsque celui-ci est appelé depuis plusieurs threads différents.</p>
<p>La solution peut être comme suit :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singleton</span>
{
    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">static</span> T<span style="color:#f92672">*</span> Get() {
            m_mutex.Lock();
            <span style="color:#66d9ef">if</span>(null <span style="color:#f92672">==</span> m_intance) {
                m_instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> T;
            }
            m_mutex.unlock();
            <span style="color:#66d9ef">return</span> m_instance;
        }

    <span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
        Singleton(){};
        <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>Singleton(){};

    <span style="color:#66d9ef">private</span> <span style="color:#f92672">:</span>
        <span style="color:#66d9ef">static</span> T<span style="color:#f92672">*</span> m_instance;
        <span style="color:#66d9ef">static</span> Mutex m_mutex;
};
</code></pre></div><p>Ici <code>Mutex</code> est une classe qui initialise le mutex dans son constructeur par défaut et présente les méthodes <code>Lock()</code> et <code>Unlock()</code> pour locker et délocker le mutex.</p>
<p>Le problème de cette solution est que le mutex est locké à chaque appel de <code>Get()</code>. Ceci peut être coûteux en nombre d’instruction en comparaison avec un simple test pour savoir si m_instance existe. D’autant plus que le Singleton n’est instancié qu’une seule fois pendant la durée de vie du programme.</p>
<p>Une proposition d’optimisation serait de tester une première fois si l’instance existe sans locker le mutex puis de tester une seconde fois sous protection dans le cas ou l’instance n’existe pas. Ceci ajoute un test dans le cas ou l’instance n’existe pas, mais enlève tout appel au mutex dans le cas ou elle existe.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singleton</span>
{
    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        <span style="color:#66d9ef">static</span> T<span style="color:#f92672">*</span> Get() {
            <span style="color:#66d9ef">if</span>(null <span style="color:#f92672">==</span> instance)
            {
                m_mutex.Lock();
                <span style="color:#66d9ef">if</span>(null <span style="color:#f92672">==</span> m_intance) {
                    m_instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> T;
                }
                m_mutex.unlock();
            }
            <span style="color:#66d9ef">return</span> m_instance;
        }

    <span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
        Singleton(){};
        <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>Singleton(){};

    <span style="color:#66d9ef">private</span> <span style="color:#f92672">:</span>
        <span style="color:#66d9ef">static</span> T<span style="color:#f92672">*</span> m_instance;
        <span style="color:#66d9ef">static</span> Mutex m_mutex;
};
</code></pre></div><p>Cette solution est valide car les accès concurrents en lecture ne sont pas pénalisant. En effet, le <code>Singleton</code> est le même pour tous les threads.</p>

                    </div>
                    <div class="meta post-footer"> <span>Aug 4 2014 03:02 UTC&#43;02</span> <a href="/posts/singleton/"><i class="fas fa-link"></i> link</a></div> 
                </div>
            
                <div class="post">
                    
                    <div class="post-content">
                        <h1 id="the-tuntap-interface-on-linux">The TUN/TAP interface on Linux</h1>
<p>Recently, I had to work with the tun interface on Linux. There is not a lot of documentation on this subject so here is a little presentation.</p>
<p>TUN/TAP is like a physical Ethernet port but for user space program. Instead of receiving data from a physical device, it receives it from a user space program and instead of sending data through a wire, sends it to a user space program.</p>
<p>This interface corresponds to a file situated in /dev/net/tun or /dev/tun. When a program opens this file, an interface is created. The name of this interface can be set by the program or automatically set by the tun driver as tunXX, tapXX or bnepXX where XX can be 0, 1, 2… This interface can be manipulated by ifconfig such as eth0.</p>
<p>More information can be found here</p>
<p>Now, i describe in the following some steps to open and use a tun interface.</p>
<p>Opening the file :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> tap <span style="color:#f92672">=</span> open(tunname[i], O_RDWR);
<span style="color:#66d9ef">if</span> (tap <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
    fprintf(stderr, <span style="color:#e6db74">&#34;TAP: failed to open TUN interfacen&#34;</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>Configuring the interface :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> ifreq ifr;
memset(<span style="color:#f92672">&amp;</span>ifr, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(ifr));
<span style="color:#75715e">/* Flags: IFF_TUN   - TUN device (no Ethernet headers)
</span><span style="color:#75715e"> *           IFF_TAP   - TAP device
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> *           IFF_NO_PI - Do not provide packet information
</span><span style="color:#75715e"> */</span>
 ifr.ifr_flags <span style="color:#f92672">=</span> IFF_TAP<span style="color:#f92672">|</span>IFF_NO_PI;
 strcpy(ifr.ifr_name, <span style="color:#e6db74">&#34;bnep&#34;</span>);

 <span style="color:#66d9ef">if</span>( ioctl(tap, TUNSETIFF, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) <span style="color:#f92672">&amp;</span>ifr) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> ) {
     fprintf(stderr, <span style="color:#e6db74">&#34;TAP: failed to set BNEP namen&#34;</span>);
     close(tap);
     tap <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
     <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
 }
</code></pre></div><p>Then we are setting the mac address :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> sockaddr sap;
sap.sa_family <span style="color:#f92672">=</span> ARPHRD_ETHER;
((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)sap.sa_data)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x00</span>;
((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)sap.sa_data)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11</span>;
((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)sap.sa_data)[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x22</span>;
((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)sap.sa_data)[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x33</span>;
((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)sap.sa_data)[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x44</span>;
((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)sap.sa_data)[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x55</span>;

memcpy((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) <span style="color:#f92672">&amp;</span>ifr.ifr_hwaddr, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) <span style="color:#f92672">&amp;</span>sap,
       <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr));

<span style="color:#66d9ef">if</span> (ioctl(tap, SIOCSIFHWADDR, <span style="color:#f92672">&amp;</span>ifr) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
      fprintf(stderr, <span style="color:#e6db74">&#34;TAP: failed to set MAC addressn&#34;</span>);
}
</code></pre></div><p>The interface is configured. We can now start to listen :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">uint8_t<span style="color:#f92672">*</span> buffer <span style="color:#f92672">=</span> (uint8_t <span style="color:#f92672">*</span>)malloc(<span style="color:#ae81ff">1500</span>);
<span style="color:#75715e">//size of an ethernet frame
</span><span style="color:#75715e"></span>assert(buffer <span style="color:#f92672">!=</span> NULL);

<span style="color:#66d9ef">while</span> (tap <span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0</span>) {
   <span style="color:#66d9ef">struct</span> timeval tv<span style="color:#f92672">=</span>{ <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>};
   fd_set rfd;
    FD_ZERO(<span style="color:#f92672">&amp;</span>rfd);
    FD_SET(tap, <span style="color:#f92672">&amp;</span>rfd);

   <span style="color:#75715e">// We are waiting for data coming to the file
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">if</span> (select(tap<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>rfd, NULL, NULL, <span style="color:#f92672">&amp;</span>tv)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>) {
       fprintf(stderr, <span style="color:#e6db74">&#34;bnep_sender: select failedn&#34;</span>);
       <span style="color:#66d9ef">break</span>;
   }

   <span style="color:#75715e">// If data to be read
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">if</span> (FD_ISSET(tap, <span style="color:#f92672">&amp;</span>rfd)) {
        n <span style="color:#f92672">=</span> read(tap, buffer, BNEP_BUFFER_SIZE);
        <span style="color:#66d9ef">if</span> (n  <span style="color:#ae81ff">0</span> )  {
            <span style="color:#75715e">//do some stuff with the data
</span><span style="color:#75715e"></span>        }
    }
}

<span style="color:#66d9ef">if</span> (buffer <span style="color:#f92672">!=</span> NULL) free(buffer);
<span style="color:#66d9ef">if</span> (tap <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) close(tap);

<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</code></pre></div><p>On the same way, we can write data to the file using ‘write’. Don’t forget the Ethernet header !</p>

                    </div>
                    <div class="meta post-footer"> <span>Dec 8 2010 11:27 UTC&#43;02</span> <a href="/posts/tun-tap/"><i class="fas fa-link"></i> link</a></div> 
                </div>
             
        </div>
    </div>
    

            </div><footer>
<div class="footer-content">
<div class="contact-info">
    
    
</div>

</div>
</footer></main>
    </body>
    <script src=http://bastien.famillepaul.fr/js/navbutton.js></script>
</html>
