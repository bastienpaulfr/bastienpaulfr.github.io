<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="echo &quot;Hello World ! &quot; Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="echo &quot;Hello World ! &quot; Blog Atom Feed"><title data-react-helmet="true">Singleton | echo &quot;Hello World ! &quot;</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://famillepaul.fr/blog/singleton"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Singleton | echo &quot;Hello World ! &quot;"><meta data-react-helmet="true" name="description" content="Présentation"><meta data-react-helmet="true" property="og:description" content="Présentation"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2014-08-04T13:02:16.000Z"><link data-react-helmet="true" rel="shortcut icon" href="/img/initiales_small.png"><link data-react-helmet="true" rel="canonical" href="https://famillepaul.fr/blog/singleton"><link data-react-helmet="true" rel="alternate" href="https://famillepaul.fr/blog/singleton" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://famillepaul.fr/blog/singleton" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.a851ad44.css">
<link rel="preload" href="/assets/js/runtime~main.0ff8d631.js" as="script">
<link rel="preload" href="/assets/js/main.17c585ab.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/initiales.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/initiales.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title"></b></a><a class="navbar__item navbar__link" href="/docs/treessence/index">Treessence</a><a class="navbar__item navbar__link" href="/docs/countries/index">AndroidCountries</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/bastienpaulfr/bastienpaulfr.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/nl-at-eof">Add a new line at the end of each text files tracked by git</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/circular-file-logger">How to create a circlular file logger with Timber</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/publish-kotlin-lib">Publish a Kotlin lib with gradle Kotlin DSL</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/dagger-material-stepper">Use Dagger Provider with Android Material Stepper</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/from-pk8-to-jks">Android : Créer un fichier keystore (jks) à partir d’une clé (.pk8) et d’un certificat (.pem)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Singleton</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2014-08-04T13:02:16.000Z" itemprop="datePublished">August 4, 2014</time> · 3 min read</div></header><div class="markdown" itemprop="articleBody"><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="présentation"></a>Présentation<a class="hash-link" href="#présentation" title="Direct link to heading">#</a></h2><p>Le singleton est un patron de conception (design pattern) dont le but est de restreindre l’instanciation  d’une classe à un nombre défini d’objets. Il est utilisé lorsque l’on a besoin que d’un seul objet pour coordonner des actions dans un système. Par exemple, le singleton va être utilisé comme gestionnaire de fenêtre, gestionnaire de systèmes de fichiers ou d’imprimantes. Le singleton va être disponible de manière globale dans un package et sera utilisé comme étant un point d’accès.</p><p>Le singleton est une classe qui va s’instancier elle-même. Ses constructeurs seront donc définis comme étant privés. Elle met à disposition une méthode statique pour récupérer son instance. Cette méthode vérifie qu’une seule instance existe ou en crée une si elle n’existe pas encore.</p><p>Une attention particulière sera donnée dans les environnements multi-threadés. Si deux thread essaient d’accéder à l’objet, un seul devra l’instancier tandis que le deuxième obtiendra une référence sur l’objet nouvellement créé.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="implémentation-en-c"></a>Implémentation en C++<a class="hash-link" href="#implémentation-en-c" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">template &lt;typename T&gt; class Singleton</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* Get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(null == m_intance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                m_instance = new T;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual ~Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private :</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Les classes peuvent ensuite hériter de <code>Singleton</code>. Elles seront instanciées par la méthode héritée <code>Get()</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">lass Eur : public Singleton&lt;Eur&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    friend class Singleton&lt;Eur&gt;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">func(){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Eur* obj = Eur::Get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="multi-threading"></a>Multi-Threading<a class="hash-link" href="#multi-threading" title="Direct link to heading">#</a></h2><p>Dans un environnement multi-tâche,  il est important de protéger le code d’instanciation pour éviter d’avoir plusieurs références vers le Singleton lorsque celui-ci est appelé depuis plusieurs threads différents.</p><p>La solution peut être comme suit :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">template &lt;typename T&gt; class Singleton</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* Get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            m_mutex.Lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(null == m_intance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                m_instance = new T;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            m_mutex.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual ~Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private :</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static Mutex m_mutex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Ici <code>Mutex</code> est une classe qui initialise le mutex dans son constructeur par défaut et présente les méthodes <code>Lock()</code> et <code>Unlock()</code> pour locker et délocker le mutex.</p><p>Le problème de cette solution est que le mutex est locké à chaque appel de <code>Get()</code>. Ceci peut être coûteux en nombre d’instruction en comparaison avec un simple test pour savoir si m_instance existe. D’autant plus que le Singleton n’est instancié qu’une seule fois pendant la durée de vie du programme.</p><p>Une proposition d’optimisation serait de tester une première fois si l’instance existe sans locker le mutex puis de tester une seconde fois sous protection dans le cas ou l’instance n’existe pas. Ceci ajoute un test dans le cas ou l’instance n’existe pas, mais enlève tout appel au mutex dans le cas ou elle existe.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">template &lt;typename T&gt; class Singleton</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* Get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(null == instance)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                m_mutex.Lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if(null == m_intance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    m_instance = new T;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                m_mutex.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual ~Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private :</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static Mutex m_mutex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Cette solution est valide car les accès concurrents en lecture ne sont pas pénalisant. En effet, le <code>Singleton</code> est le même pour tous les threads.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/mutex-locker"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Mutex Locker</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/tun-tap"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">The TUN/TAP interface on Linux »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#présentation" class="table-of-contents__link">Présentation</a></li><li><a href="#implémentation-en-c" class="table-of-contents__link">Implémentation en C++</a></li><li><a href="#multi-threading" class="table-of-contents__link">Multi-Threading</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/treessence/index">Treessence</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/countries/index">AndroidCountries</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/users/1442734/bipi" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/bastienpaulfr" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Bastien PAUL, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0ff8d631.js"></script>
<script src="/assets/js/main.17c585ab.js"></script>
</body>
</html>