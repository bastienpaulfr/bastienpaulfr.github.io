<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="echo &quot;Hello World ! &quot; Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="echo &quot;Hello World ! &quot; Blog Atom Feed"><title data-react-helmet="true">Blog | echo &quot;Hello World ! &quot;</title><meta data-react-helmet="true" property="og:title" content="Blog | echo &quot;Hello World ! &quot;"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://famillepaul.fr/blog"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/img/initiales_small.png"><link data-react-helmet="true" rel="canonical" href="https://famillepaul.fr/blog"><link data-react-helmet="true" rel="alternate" href="https://famillepaul.fr/blog" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://famillepaul.fr/blog" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.a851ad44.css">
<link rel="preload" href="/assets/js/runtime~main.fde905a3.js" as="script">
<link rel="preload" href="/assets/js/main.d015e873.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/initiales.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/initiales.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title"></b></a><a class="navbar__item navbar__link" href="/docs/treessence/index">Treessence</a><a class="navbar__item navbar__link" href="/docs/countries/index">AndroidCountries</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/bastienpaulfr/bastienpaulfr.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/converters">How to make a good converter</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/nl-at-eof">Add a new line at the end of each text files tracked by git</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/circular-file-logger">How to create a circlular file logger with Timber</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/publish-kotlin-lib">Publish a Kotlin lib with gradle Kotlin DSL</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/dagger-material-stepper">Use Dagger Provider with Android Material Stepper</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/converters">How to make a good converter</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2022-07-08T12:55:46.000Z" itemprop="datePublished">July 8, 2022</time> ¬∑ 5 min read</div></header><div class="markdown" itemprop="articleBody"><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="purpose"></a>Purpose<a class="hash-link" href="#purpose" title="Direct link to heading">#</a></h2><p>The purpose of the <strong>Converter</strong> pattern is to provide a generic, common way of bidirectional conversion between corresponding types, allowing a clean implementation in which the types do not need to be aware of each other.</p><p>In plain words, the <strong>Converter</strong> pattern makes it easy to map instances of one class into instances of another class.</p><p>We&#x27;re making use of Converter to map models when they are <strong>propagating between layers</strong> (API, Data, Domain, Presentation) to make them <strong>convenient to work with on a specific layer</strong> and do <strong>not spread extra dependencies to other layers</strong>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="dip"></a>DIP<a class="hash-link" href="#dip" title="Direct link to heading">#</a></h3><p>Conversion is here to comply with dependency inversion principle. Domain layer only know about itself. <strong>UI</strong> <strong>layer</strong> needs to convert <strong>UI</strong> <strong>model</strong> into <strong>Domain</strong> <strong>DTO</strong> to deal with <strong>Domain</strong> <strong>layer</strong>. <strong>Data layer</strong> needs to convert <strong>Data model</strong> into <strong>Domain dto</strong> to deals with <strong>Domain layer</strong>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="srp"></a>SRP<a class="hash-link" href="#srp" title="Direct link to heading">#</a></h3><p>We want to extract conversion methods to comply with Single Responsibility Principle. Putting conversion logic in its own scope, makes it easier to test. Extracting conversion logic from other classes, ensure that they focus on their business and not in conversion logic.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="implementation"></a>Implementation<a class="hash-link" href="#implementation" title="Direct link to heading">#</a></h2><p>Actually, there are different uses cases that we should handle that would trigger different implementations</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="simple-extension-method"></a>Simple extension method<a class="hash-link" href="#simple-extension-method" title="Direct link to heading">#</a></h3><p>For the simpler cases, it is advised to stick with <a href="https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it" target="_blank" rel="noopener noreferrer">YAGNI</a> principle and have only an extension method in a file named <code>&lt;source type&gt;To&lt;destination type&gt;Converter.kt</code> because you aren‚Äôt gonna need a class.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">fun MyModel.toMyOtherModel() = MyOtherModel(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   attr1 = id,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   attr2 = name,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><p>But I need to handle lists of items !</p><p>Kotlin is here to help thanks to the <code>map{}</code> extension to collection classes</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// Given this converter method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fun MyModel.toMyOtherModel(): MyOtherModel {}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// And the fact that we have a list of objects to convert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val myModels = listOf(myModel1, myModel2, myModel3)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Convertion could be done with map extension method.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val myOtherModels = myModels.map { it.toMyOtherModel() }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>‚ùå Do not call extension method from domain layer.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="simple-class"></a>Simple class<a class="hash-link" href="#simple-class" title="Direct link to heading">#</a></h3><p>You can create a converter class if you want to use Injection features or if you need additional contributors. You should always avoid to use kotlin <code>objects</code> because using a Singleton is often a code smell. It is a ressource killer because never destoyed. They are hiding dependencies and states and they are making your application more coupled.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="example"></a>Example<a class="hash-link" href="#example" title="Direct link to heading">#</a></h4><p>üëâ¬†Create the <strong>converter class</strong> that can be injected thanks to <code>@Inject</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class ATypeToAnotherTypeConverter @Inject constructor()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun convert(from: AType): AnotherType = when (this) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            AType.A-&gt; AnotherType.A</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            AType.B-&gt; AnotherType.B</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="we-need-an-additional-contributor"></a>We need an additional contributor<a class="hash-link" href="#we-need-an-additional-contributor" title="Direct link to heading">#</a></h3><p>Sometimes you‚Äôll need an additional contributor like a <code>LocaleProvider</code> or a <code>DateProvider</code></p><p>üëâ¬†Inject them in the converter class</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class DomainDtoToUiModel @Inject constructor(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // here timezone is dynamic, it is retrieved from a provider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeZoneProvider: TimeZoneProvider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Here date format is static. To make is dynamic, format can be injected in constructor.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private val simpleDateFormat = SimpleDateFormat(/*...*/)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      fun convert(dto: DomainDto): UiModel {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return UiModel(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            displayDate = simpleDateFormat.format(dto.currentDate, timeZoneProvider.getLocalTimeZone())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="we-need-a-converter-with-additional-parameters"></a>We need a converter with additional parameters<a class="hash-link" href="#we-need-a-converter-with-additional-parameters" title="Direct link to heading">#</a></h3><p>Most of the time, it is an unexpected case. Converters have 1:1 relationship.</p><p>üí° If logic begins to be complex, or you‚Äôre creating several implementations of an interface, you should consider using a <a href="https://refactoring.guru/design-patterns/factory-method" target="_blank" rel="noopener noreferrer">Factory</a> or a <a href="https://refactoring.guru/design-patterns/builder" target="_blank" rel="noopener noreferrer">Builder</a> instead.</p><p>You might want to convert a domain DTO in a model of UI or data layer, then use the last model along a factory to create more complex instance.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="do"></a>‚úÖ¬†Do<a class="hash-link" href="#do" title="Direct link to heading">#</a></h3><ul><li>Place converter in UI or Data layer (along ViewModel or DataSource)</li><li>Make converter as simple as possible</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="dont"></a>‚ùå¬†Don‚Äôt<a class="hash-link" href="#dont" title="Direct link to heading">#</a></h3><ul><li>üß®¬†Conversion method can crash</li><li>Call converter from Domain layer</li><li>Implement complex logic</li><li>Extend very common classes like <code>String</code>, <code>Long</code> or <code>Int</code></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="naming"></a>Naming<a class="hash-link" href="#naming" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="class"></a>Class<a class="hash-link" href="#class" title="Direct link to heading">#</a></h3><p><code>&lt;source type&gt;To&lt;destination type&gt;Converter</code>, e.g.:</p><ul><li><code>LocalCardToCardConverter</code> (LocalCard üëâ Card)</li><li><code>RequestToLocalRequestConverter</code> (Request üëâ LocalRequest)</li></ul><p>üí° It should be clear what types converters are converting. This is the reason why the <strong>source</strong> type <strong>and</strong> the <strong>destination</strong> type are mentioned.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="extension-method"></a>Extension method<a class="hash-link" href="#extension-method" title="Direct link to heading">#</a></h3><p>The extension method used for converting the extended object into the target one should be named : <code>fun Model.toNameOfTargetedClass(){}</code></p><p>It should belong to a file named <code>&lt;source type&gt;To&lt;destination type&gt;Converter.kt</code></p><p>üí° The <strong>destination type</strong> of the converter extension method should be crystal clear. A model can also be converted in <strong>several</strong> kind of classes. This is the reason why methods like <code>.toDomainModel()</code> or <code>.toDataModel()</code> are not encouraged.</p><p>Given this data classes:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// Data layer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">data class RemoteTypeOfMyObject()</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Domain layer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">data class MyAwesomeData()</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// UI layer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">data class AwesomeUiState()</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then we should have these extension methods</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// Data layer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fun RemoteTypeOfMyObject.toMyAwsomeData(): MyAwesomeData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fun MyAwesomeData.toRemoteTypeOfMyObject(): RemoteTypeOfMyObject</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// UI Layer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fun AwsomeUiState.toMyAwsomeData(): MyAwesomeData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fun MyAwesomeData.toAwesomeUiState(): AwesomeUiState</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="file"></a>File<a class="hash-link" href="#file" title="Direct link to heading">#</a></h2><p>Converter class or methods should be placed into their belonging layer, not in the domain one.</p><p>‚ö†Ô∏è Domain layer should not know about classes that are in UI or in Data layer.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">root</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  |- Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  |    |-...- RemoteTypeOfMyObject.kt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  |    |-...- RemoteTypeOfMyObjectConverter.kt  &lt;- Converter is here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  |- Domain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     /!\ No converters here /!\</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  |- UI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      |-...- AwsomeUiState.kt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      |-...- AwsomeUiStateConverter.kt &lt;- Converter is here</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="layers"></a>Layers<a class="hash-link" href="#layers" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="data"></a>Data<a class="hash-link" href="#data" title="Direct link to heading">#</a></h3><p>Converters in data layer should be called from data sources. Repositories are dealing with business models.</p><blockquote><p>A source is part of the external world : everything that you don‚Äôt own and that you want to scope into the smallest possible part. No-one should know about your source implementation details except the source itself. So it should be responsible to expose a model that the consumer can undestand without having to know the implementation details of that source</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ui"></a>UI<a class="hash-link" href="#ui" title="Direct link to heading">#</a></h3><p>Converters in UI layer should be called from ViewModels. They are the bridge between UI model and business rules (implemented in UseCases)</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/nl-at-eof">Add a new line at the end of each text files tracked by git</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-03-30T13:04:26.000Z" itemprop="datePublished">March 30, 2020</time> ¬∑ One min read</div></header><div class="markdown" itemprop="articleBody"><p>One of the most anoying thing I meet when I am coding software, is the ¬´ No new line at end of file ¬ª warning.</p><p><img alt="manifest" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAXoAAAA6CAIAAAAx7QUfAAAACXBIWXMAAA7EAAAOxAGVKw4bAAALMUlEQVR42u2ba1Mb1xnH/RUySGAkdEErYTu2wRgRg0EyuoLQ6oq0K2l1wUhIIIRAq9siIUCA41A3zuRFOp2p0ySTZtJpMp2kradNG7fETutx0klcf4d+jnbkg+W1hNbCBkLI85//C2m1u+do95yfnuc5qxO688oj5VeGjEetS2AweF98AnADBoMBN2Aw+HjhhjfcfaT8ypDxqHUJDAbviwE3YDAYcAMGgwE3gBswGAy4+cGMbdxrwx01G1tUvZLULfm1+/Jr93nqizDawICbvR0g0vfrI15XKurLJdpHnk6hPsKEz016MvHhgKP+qNc8uC+XUIyrfnDcnHR4sfJ2i6p3f08r8CX4uuGaje1EWFb608u0xddf6brxiKfug5EK/inipkPb3+M0nrFqanBzzq47hV8xRDz1uBEbLplmAp5M/OVxg5mGmjkJh6XZjzpC+cO5uMIQI1m89TJnANyAIZnqFusv1eAGWXOVqMFNy9D5sZhfNja0L7jpJ82XKVtTnVT3C7zxTuYT3pX+6sa2cUslrxnpfxJ63Jat/rWT+VQUvS7f/FoYYna+3dzb2Pq2/I1vZaU/t9k9O2Fd7LokdUuafh9b+aKT+ZSv2/ku4tmbWPmOYushO5lqs3uw8p1KGnX9G6x8Byvf2UmmRgbEibflG1/JN77qiGy0qC7sgIlKYmtfyq/dl63+rd0dRhtly7ex8nbXjUdY+e9Y+U5HZONx397qiJT5Bi2MXTDgphY3PU6jOjTBG+4+NNy0jVvE8ZvyzX9K0h+0E5EW1keShV+KpjeqmQ62+gVP1Yut/EUUWWszWytQQJN/colvGGmp7BORv/EtTzOIcINt3kMZkyR1q3oejtqNcLJYE91I6fck9Lu8kUt87bCs8JmQSla2ay4rth62jpsr4YxhpG0c54huWsfN4tk3sc170syH7e7wvmeFYPCPFTcCTZ89GW7X9L0kbqTGQVcq6kpFifQMkZ5Fr7vM6lrQWF2ywmey5dsdIaa+ksI3aOXXv6lGJe1EWJr5sHLyzIcCIsobGZC/8e/6puWbX5+0uneim+QvdjgSzElTv94rbvg6VdeNR3y9plruQR3ga4cUW9+1e+Mo7GoqmVL1trvDlVBrfVs4ycA4BgNuKm97XaPo9cvghj/cI9QqhVrlIGVTBZ3odau6p7YMPBHCNu9JFn/VPhGs/9kXzdwQz73NruNK0h9UQpVKEBTmjfQrtr7bqU+FGNnyH1ESpNj6/uTjfEoUuy6efXOHI4E0IsWecNOGOxQ/+w86bcXr251Lv6/2vDP7seL1B7Li5224tZnaTatpXBS9jq3fFc/ehHEMBtx0O5JhXy7Bdj9pPthkSn1RQMY6cx9j63dFsa2niYlmUPH6g9YxIyduvq9sdwbkG1+1ju7sKb92/6TDuy+44etUiq2HPLWyYedVveL4zc78b1mHINw8PYSvHRIGMrLi59jalx1XS3zdFRjE4OOMm1Z1j9Q44MslBBolX/UkxFD1tKp7tFOkKuisjzsOs3az08lRgyh6Ddu4h0rFHVOrlaLJs6vUu+OGjMmWb6MiroCMdd14tF+4qSRu6ffFc2/xRgZaVBfaxnEUN/H16vaJIE/d16K6IJr9uZR+j/3kjmLruzbL0zNL6Hcli7dOOqgWGL7gY48bgaaPHa14MnG0XRV0ckcx+4KbvbpF1VuZlmoltlmLg0a44al6Jcl3ZKXb0sxvOiJlbP0fHLhpNeqf5FwPsfW7WPmOwJ/iwA1PM4CWvRSvP+gs/gEtQvENI53MJ4+fBvyXNPsR36B75smDUF6+vo2tb4umN1H3YNSC4anio/tUsSCQkuZ/BzcbDAbcHDxufIlWsw1uNhgMuDkO/5kCg8GAGzAYDLgB3IDBgBvADRgMPhDcnDj72pHyK0NGgcYMBoOPnwE3YDAYcAMGgwE3gBswGAy4+VF6kAqT6aKfWX3Nc7X+037PpDmeOk7f94yF9GSXX/hw2ZjTnsz5ciU8Tr/wzsZo8jIVafIWgAE3u1humqDyK2K9tZmdMZMzVCgbIgn09jIVaWb4HpzHZ1O7jnXFuKvbSR1aNy66g7b57FHGjeZqXDsVf8mdz9m9p3B3k7cADLjZ3WOxhSH/dPO48eVKEoPtKOPmkH30cbOnC3VwO4MBNztDWajFm49uUFDNxs0ZC4kicMdC7qzNy3GSDp0lVCgPB6Zt81kyXWQP1vMOn2OhchLbfKbL7BJozGS6eMZCPhPST88PUuFGYx0zOQm64M2W2MkUR4uXqYibXvJmS6OxBe4QT2q0meMpb7ZE5VfwOC0bdaDYkKALnuxygFkj6AJBF54bVdW3yNG94cC0J7tMZoqqYPS5uFESITe95MtVvjvqHmqOoAt+ZtWbLRF0YSy2wN23XXfucwcJukDlV9jJVKNbINJZ9JEEmSk+7nYMeAG4qbU1ken3TDaJm1O4m6ALbNx06Cye7DI6Q68rQOVXUPjDgRtVMCrQmLvMLj+zKtJZBBrzKdxN5VcQqtD4FmpxYzR5yTvFPtyVYl61ktw/rTW1m0YtXvJOuVIMZnIKtbguPGecnueqaIw6lOQkAsTI1Vl2ONN8dLNri4261+OkPNllzOQU6622+Sw3bk7jBJVfOY0TQi3+uHsZ9qfm+B5ikEY719RuGt0C08ziWGxBpLNIDDZ7MqckJwEZgJtn3O2k3PRSk7jp0FnwON3jpKq4Oe/wsSfDxCJz0R3kxo1szIne+nIlFMjownP6J1UhgcZM0IUzFvKSd8oYTQo05srAJUJivdXPrFYDsT3hpr5FV4rpe9JP2ZjTz6w2ebkU467g0toL4GbXFht1zxBJaK7Gq01w40Ydio0+CUYkBluoUO402g8fN1JjpelqbKUkQsesZg+42Z+VqYlF5sKEv0nc9DgpPE5XcaMkQs7FfHU3PE4P+MLcuKmGP95sCaVLKFVBKQlKiHqc1Cnc7aaXOo12ezI3Gls4Z/eyf7f3hJv6Fv3MKpkpVlus1qQadVs7FXelGIIukOliqFB+Adzs2iLHBalO71etz6ndsNkk0JgDzBq7rHtouDmNE8GlteoXJNPFg65qAW5+lLhREiF7MtckblD0YYgkXji6qZ9duvDcrqk+lV8Z8IWV5KRtPjMcmFaHYuwid02qtSfcuFLMObu3yeujDsXwOI2SqS6z68Vws2uLjbpniCSuTM6gjSixOoLRTc0tkBptwaU1NELAgJuGFmpxMl08a/M0iZvLVMTPrDaq3UiNtr3i5jROeLLL6LVYb73oDqKG8DhNZoqyUceVyRkyU+xh1WJVwdiutc8mcTPgC9vmMyiLkY06el0Bju+uC89Vl4e1U3E2bs7aPJ7ssqiJObZri4261+2kXCkGXQTTzCI3bs5YSHbtpuaX4+BwU38LTDOLuvAcuhpdZhf3ugH4p/uY3yAV5s602biRGGxV3FRXpqj8inMxzx0yNJpdaIKh5S1PdtkYTaKGVMHoxCKDZjX7QNQHayKDGq0+M4ISMT+zStAFV4rhbnGQCrtSDJVfcdNLw4Fp7lKxNZGxJ3MoVWTjBk3FyhJSuvjclan6Fjm6N+SfnlhkbPMZ7VT8+StT5CRamcLjNGZy7iNu7MkcWpny5UooquW4BWK9VReeI9NFKr/iWMg9N0MH/0RxI9JZqnVKMBgMuDnYPzFcmPBD9AsGA27gP1NgMOAGcAMGgwE3YDAYcAO4AYPBTeDmvyAQCHQoOvE/EAgEOhQBbkAgEOAGBAIBbkAgEAhwAwKBADcgEAhwA5cABAIBbkAgEOAGBAKBADcgEAhwAwKBADcgEAgEuAGBQIAbEAgE2rP+D+j4OtLe4HK/AAAAAElFTkSuQmCC"></p><p>For this, I have written a little script based of my research on google. I want to rewrite all text files tracked by git and ensure that a new line is written at the end of file.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># list all files tracked by git</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for file in `git ls-files -c -m`;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">do</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Test that file does exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [ -f $file ]; then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Test that file is not a binary one</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    grep -Iq . &quot;$file&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if [ $? -eq 0 ]; then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Add a new line</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      sed -i &#x27;$a\&#x27; $file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You can execute it from a git repository and commit the result.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/circular-file-logger">How to create a circlular file logger with Timber</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-03-01T13:04:06.000Z" itemprop="datePublished">March 1, 2019</time> ¬∑ 7 min read</div></header><div class="markdown" itemprop="articleBody"><p>In some applications, I need to store my logs in a file aside of traditional logcat. For this, I am making use of <a href="https://github.com/JakeWharton/timber" target="_blank" rel="noopener noreferrer">Timber</a> library. Because I don‚Äôt want to make my device full of logs, I wanted to use circular log files so that I can control the maximum amount of bytes taken by log data. To achieve this, I will use java Logger API to implement a new <code>Timber.Tree</code>. I also want some feature like log formatting and filtering.</p><p>All of this is implemented by <a href="https://github.com/bastienpaulfr/Treessence" target="_blank" rel="noopener noreferrer">Treessence</a> library.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="log-filtering"></a>Log filtering<a class="hash-link" href="#log-filtering" title="Direct link to heading">#</a></h2><p>To implement filtering an interface is defined :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Filter {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param priority Log priority.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param tag      Tag for log.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param message  Formatted log message.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param t        Accompanying exceptions.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {@code true} if the log should be skipped, otherwise {@code false}.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @see timber.log.Timber.Tree#log(int, String, String, Throwable)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean skipLog(int priority, String tag, String message, Throwable t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isLoggable(int priority, String tag);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Priority filtering is provided by an implementation of this interface</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class PriorityFilter implements Filter {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int minPriority;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PriorityFilter(int minPriority) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.minPriority = minPriority;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean skipLog(int priority, String tag, String message, Throwable t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return priority &lt; minPriority;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isLoggable(int priority, String tag) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return priority &gt;= minPriority;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getMinPriority() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return minPriority;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We can now create our base class extending <code>Timber.DebugTree</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class PriorityTree extends Timber.DebugTree {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PriorityFilter priorityFilter;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Filter filter = NoFilter.INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param priority priority from witch log will be logged</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PriorityTree(int priority) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.priorityFilter = new PriorityFilter(priority);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Add additional {@link Filter}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param f Filter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return itself</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PriorityTree withFilter(@NotNull Filter f) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.filter = f;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean isLoggable(int priority) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isLoggable(&quot;&quot;, priority);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isLoggable(String tag, int priority) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return priorityFilter.isLoggable(priority, tag) &amp;&amp; filter.isLoggable(priority, tag);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PriorityFilter getPriorityFilter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return priorityFilter;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Filter getFilter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return filter;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Use the additional filter to determine if this log needs to be skipped</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param priority Log priority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param tag      Log tag</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param message  Log message</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param t        Log throwable</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true if needed to be skipped or false</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean skipLog(int priority, String tag, @NotNull String message, Throwable t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return filter.skipLog(priority, tag, message, t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This class can filter on two parameters :</p><ul><li>First parameter is obviously log priority. This is done thanks to PriorityFilter instance.</li><li>Second parameter is an additional Filter instance that can be provided by caller.</li></ul><p>##¬†Log formatting</p><p>Log formatting is obtained thanks to a Formatter class whose interface is defined as follow</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Formatter {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String format(int priority, String tag, String message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Each formatter can display log to a defined format. For instance, logcat format is <code>&quot;MM-dd HH:mm:ss:SSS {priority}/{tag}({thread id}) : {message}\n&quot;</code>. Another format would be <code>&quot;{tag} : {message}&quot;</code>.</p><p>Because we want to log in a file what we get in logcat, then we need to implement a logcat formatter</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class LogcatFormatter implements Formatter {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final LogcatFormatter INSTANCE = new LogcatFormatter();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String SEP = &quot; &quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final HashMap&lt;Integer, String&gt; prioPrefixes = new HashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private LogcatFormatter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        prioPrefixes.put(Log.VERBOSE, &quot;V/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        prioPrefixes.put(Log.DEBUG, &quot;D/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        prioPrefixes.put(Log.INFO, &quot;I/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        prioPrefixes.put(Log.WARN, &quot;W/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        prioPrefixes.put(Log.ERROR, &quot;E/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        prioPrefixes.put(Log.ASSERT, &quot;WTF/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String format(int priority, String tag, @NotNull String message) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String prio = prioPrefixes.get(priority);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (prio == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            prio = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return TimeUtils.timestampToDate(System.currentTimeMillis(), &quot;MM-dd HH:mm:ss:SSS&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               + SEP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               + prio</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               + (tag == null ? &quot;&quot; : tag)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               + &quot;(&quot; + Thread.currentThread().getId() + &quot;) :&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               + SEP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               + message</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               + &quot;\n&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Priority class can then be extended to add format functionality</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Base class to format logs</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FormatterPriorityTree extends PriorityTree {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Formatter formatter = getDefaultFormatter();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FormatterPriorityTree(int priority) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(priority);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Set {@link Formatter}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param f formatter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return itself</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FormatterPriorityTree withFormatter(Formatter f) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.formatter = f;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Use its formatter to format log</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param priority Priority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param tag      Tag</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param message  Message</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Formatted log</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String format(int priority, String tag, @NotNull String message) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return formatter.format(priority, tag, message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Default log {@link Formatter}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Formatter getDefaultFormatter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NoTagFormatter.INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void log(int priority, String tag, @NotNull String message, Throwable t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.log(priority, tag, format(priority, tag, message), t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="file-logging"></a>File logging<a class="hash-link" href="#file-logging" title="Direct link to heading">#</a></h2><p>We have seen how to filter and format logs. We can now start logging in file.</p><p>For this we need a <code>java.util.logging.Logger</code> instance. It will be used in conjunction with <code>java.util.logging.FileHandler</code> that do actual file logging. We will see how to create a Logger instance later.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class FileLoggerTree extends FormatterPriorityTree {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Logger logger;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private FileLoggerTree(int priority,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           Logger logger) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(priority);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.logger = logger;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To activate logcat formatting by default, <code>getDefaultFormatter()</code> method is overridden</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected fr.bipi.tressence.common.formatter.Formatter getDefaultFormatter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return LogcatFormatter.INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We need to convert logcat level to <code>java.util.logging.Level</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">private Level fromPriorityToLevel(int priority) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch (priority) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case Log.VERBOSE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Level.FINER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case Log.DEBUG:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Level.FINE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case Log.INFO:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Level.INFO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case Log.WARN:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Level.WARNING;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case Log.ERROR:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Level.SEVERE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case Log.ASSERT:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Level.SEVERE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Level.FINEST;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Logging is done by this method</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected void log(int priority, String tag, @NotNull String message, Throwable t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (skipLog(priority, tag, message, t)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger.log(fromPriorityToLevel(priority), format(priority, tag, message));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.log(fromPriorityToLevel(priority), &quot;&quot;, t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It is logging in using <code>java.utils.logging</code> API with log level conversion and logcat formatting</p><p>We haven‚Äôt seen how to provide the right logger. Let see how to configure it.</p><p>A builder class is defined to create a FileLoggerTree instance. This builder contains some default:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public static class Builder {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1 mb byte of data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int SIZE_LIMIT = 1048576;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Max 3 files for circular logging</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int NB_FILE_LIMIT = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Base filename.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // log index will be appended so actual file name will be</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // &quot;log.0&quot; or &quot;log.1&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // To parametrize where index is put, &quot;%g&quot; can be placed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // in file name. For instance &quot;log%g.logcat&quot; will give</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // &quot;log0.logcat&quot;, &quot;log1.logcat&quot; and so on</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String fileName = &quot;log&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Directory where files are stored</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String dir = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Min priority to log from</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int priority = Log.INFO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int sizeLimit = SIZE_LIMIT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int fileLimit = NB_FILE_LIMIT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // append log to already existing log file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean appendToFile = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>java.util.logging.Logger</code> are created and managed by <code>java.util.logging.LogManager</code>. To bypass this a simple static class is used</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Custom logger class that has no references to LogManager</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private static class MyLogger extends Logger {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Constructs a {@code Logger} object with the supplied name and resource</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * bundle name; {@code notifyParentHandlers} is set to {@code true}.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * &lt;p/&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">* Notice : Loggers use a naming hierarchy. Thus &quot;z.x.y&quot; is a child of &quot;z.x&quot;.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param name the name of this logger, may be {@code null} for anonymous</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *             loggers.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyLogger(String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(name, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Logger getLogger(String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new MyLogger(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Creation of <code>java.util.logging.Logger</code> can start</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public FileLoggerTree build() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Log file path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  String path = FileUtils.combinePath(dir, fileName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // File handler that is performing file logging</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  FileHandler fileHandler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Our custom logger</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Logger logger = MyLogger.getLogger(TAG);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // We force level to ALL because priority filtering is</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // done by our Tree implementation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  logger.setLevel(Level.ALL);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // File handler can now be created</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  fileHandler = new FileHandler(path, sizeLimit, fileLimit,  appendToFile);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Formating is done by our Tree implementation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  fileHandler.setFormatter(new NoFormatter());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Configure java Logger</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  logger.addHandler(fileHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // finally we got here !</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return new FileLoggerTree(priority, logger);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Full code of <code>FileLoggerTree</code> is <a href="https://github.com/bastienpaulfr/Treessence/blob/master/treessence/src/main/java/fr/bipi/tressence/file/FileLoggerTree.java" target="_blank" rel="noopener noreferrer">here</a></p><p>This tree can then be planted like this</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">FileLoggerTree fileTree = FileLoggerTree.Builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .withFileName(&quot;log%g.logcat&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .withMinPriority(Log.VERBOSE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .build()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Timber.plant(fileTree)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Thanks for reading this. Full source code is available <a href="https://github.com/bastienpaulfr/Treessence" target="_blank" rel="noopener noreferrer">here</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/publish-kotlin-lib">Publish a Kotlin lib with gradle Kotlin DSL</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-02-08T13:03:53.000Z" itemprop="datePublished">February 8, 2019</time> ¬∑ 4 min read</div></header><div class="markdown" itemprop="articleBody"><p>I wanted to play more with Kotlin and I wanted to publish <a href="https://github.com/bastienpaulfr/geojson-kotlin" target="_blank" rel="noopener noreferrer">KGeoGson</a> lib to a remote maven repo.</p><p>I was following <a href="https://guides.gradle.org/building-kotlin-jvm-libraries/" target="_blank" rel="noopener noreferrer">gradle guide</a> to build my kotlin project with Kotlin DSL.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="bootstrap-kotlin-project"></a>Bootstrap Kotlin project<a class="hash-link" href="#bootstrap-kotlin-project" title="Direct link to heading">#</a></h2><p>Create project directory with files of your library you want to build and publish. You may have a directory structure like the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">project</span></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ build.gradle.kts</span></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ settings.gradle.kts</span></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îî‚îÄ‚îÄ my-kotlin-library</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚îú‚îÄ‚îÄ build.gradle.kts</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚îî‚îÄ‚îÄ src</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ‚îú‚îÄ‚îÄ main</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ‚îÇ   ‚îî‚îÄ‚îÄ kotlin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ‚îÇ       ‚îî‚îÄ‚îÄ org</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ‚îÇ           ‚îî‚îÄ‚îÄ example</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ‚îÇ               ‚îî‚îÄ‚îÄ MyLibrary.kt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ‚îî‚îÄ‚îÄ test</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ‚îî‚îÄ‚îÄ kotlin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ‚îî‚îÄ‚îÄ org</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ‚îî‚îÄ‚îÄ example</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ‚îî‚îÄ‚îÄ MyLibraryTest.kt</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h2><p>Root <strong>build.gradle.kts</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">plugins {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   `build-scan`</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">buildScan {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   termsOfServiceUrl = &quot;https://gradle.com/terms-of-service&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   termsOfServiceAgree = &quot;yes&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   publishAlways()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val clean by tasks.creating(Delete::class) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   delete(rootProject.buildDir)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In this file, ¬´ build-scan ¬ª plugin is activated and a clean task is added. That‚Äôs all for it</p><p><strong>settings.gradle.kts</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">include(&quot;lib&quot;)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In this file, we define our modules</p><p><strong>lib/build.gradle.kts</strong></p><p>First we are adding some plugins</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">plugins {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Add Kotlin plugin to build our Kotlin lib</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   kotlin(&quot;jvm&quot;) version &quot;1.3.21&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Get version from git tags</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   id(&quot;fr.coppernic.versioning&quot;) version &quot;3.1.2&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Documentation for our code</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   id(&quot;org.jetbrains.dokka&quot;) version &quot;0.9.17&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Publication to bintray</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   id(&quot;com.jfrog.bintray&quot;) version &quot;1.8.4&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Maven publication</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   `maven-publish`</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then we are defining dependencies and their repositories for our code</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">repositories {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   jcenter()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   mavenCentral()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dependencies {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   implementation(&quot;org.jetbrains.kotlin:kotlin-stdlib-jdk7&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   implementation(&quot;com.google.code.gson:gson:2.8.5&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   testCompile(&quot;junit:junit:4.12&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We need some more tasks to add sources and javadoc to our lib. We are starting by configuring dokka task:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">tasks {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   dokka {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       outputFormat = &quot;html&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       outputDirectory = &quot;$buildDir/javadoc&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       moduleName = rootProject.name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We can then bundle documentation into a jar</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">val dokkaJar by tasks.creating(Jar::class) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   group = JavaBasePlugin.DOCUMENTATION_GROUP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   description = &quot;Assembles Kotlin docs with Dokka&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   archiveClassifier.set(&quot;javadoc&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   from(tasks.dokka)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   dependsOn(tasks.dokka)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We are creating another jar containing sources</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">val sourcesJar by tasks.creating(Jar::class) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   archiveClassifier.set(&quot;sources&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   from(sourceSets.getByName(&quot;main&quot;).allSource)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>At this stage, you are able to compile your lib. The most important part of this article begins. Let‚Äôs see how publication is working. It is very important to configure pom.xml file of maven artifact in a right manner. Otherwise you will not be able to submit your library into JCenter repo.</p><p>Let‚Äôs start configuring base of maven publish plugin</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">val artifactName = &quot;libname&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val artifactGroup = &quot;org.example&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">publishing {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   publications {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       create&lt;MavenPublication&gt;(&quot;lib&quot;) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           groupId = artifactGroup</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           artifactId = artifactName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // version is gotten from an external plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           version = project.versioning.info.display</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // This is the main artifact</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           from(components[&quot;java&quot;])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // We are adding documentation artifact</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           artifact(dokkaJar)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // And sources</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           artifact(sourcesJar)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now we need to add information about package in <strong>pom.xml</strong> file. You can edit <strong>pom.xml</strong> with <code>pom.withXml {</code> code</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">val pomUrl = &quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomScmUrl = &quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomIssueUrl = &quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomDesc = &quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomScmConnection = &quot;&quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomScmDevConnection = &quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val githubRepo = &quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val githubReadme = &quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomLicenseName = &quot;The Apache Software License, Version 2.0&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomLicenseUrl = &quot;http://www.apache.org/licenses/LICENSE-2.0.txt&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomLicenseDist = &quot;repo&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomDeveloperId = &quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">val pomDeveloperName = &quot;...&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">publishing {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   publications {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       create&lt;MavenPublication&gt;(&quot;lib&quot;) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           [...]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           pom.withXml {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               asNode().apply {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   appendNode(&quot;description&quot;, pomDesc)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   appendNode(&quot;name&quot;, rootProject.name)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   appendNode(&quot;url&quot;, pomUrl)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   appendNode(&quot;licenses&quot;).appendNode(&quot;license&quot;).apply {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                       appendNode(&quot;name&quot;, pomLicenseName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                       appendNode(&quot;url&quot;, pomLicenseUrl)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                       appendNode(&quot;distribution&quot;, pomLicenseDist)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   appendNode(&quot;developers&quot;).appendNode(&quot;developer&quot;).apply {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                       appendNode(&quot;id&quot;, pomDeveloperId)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                       appendNode(&quot;name&quot;, pomDeveloperName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   appendNode(&quot;scm&quot;).apply {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                       appendNode(&quot;url&quot;, pomScmUrl)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                       appendNode(&quot;connection&quot;, pomScmConnection)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now that your maven publication is well configured, you can configure bintray plugin</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">bintray {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Getting bintray user and key from properties file or command line</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   user = if (project.hasProperty(&quot;bintray_user&quot;)) project.property(&quot;bintray_user&quot;) as String else &quot;&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   key = if (project.hasProperty(&quot;bintray_key&quot;)) project.property(&quot;bintray_key&quot;) as String else &quot;&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Automatic publication enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   publish = true</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Set maven publication onto bintray plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   setPublications(&quot;lib&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Configure package</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   pkg.apply {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       repo = &quot;maven&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       name = rootProject.name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       setLicenses(&quot;Apache-2.0&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       setLabels(&quot;Gson&quot;, &quot;json&quot;, &quot;GeoJson&quot;, &quot;GPS&quot;, &quot;Kotlin&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       vcsUrl = pomScmUrl</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       websiteUrl = pomUrl</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       issueTrackerUrl = pomIssueUrl</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       githubRepo = githubRepo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       githubReleaseNotesFile = githubReadme</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // Configure version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       version.apply {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           name = project.versioning.info.display</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           desc = pomDesc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           released = Date().toString()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           vcsTag = project.versioning.info.tag</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we is ! Happy publication !</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/dagger-material-stepper">Use Dagger Provider with Android Material Stepper</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-01-24T13:03:38.000Z" itemprop="datePublished">January 24, 2019</time> ¬∑ 2 min read</div></header><div class="markdown" itemprop="articleBody"><p>On an Android project, I am using <a href="https://github.com/stepstone-tech/android-material-stepper" target="_blank" rel="noopener noreferrer">android-material-stepper</a> from StepStone. I am also using dependency injection with <a href="https://google.github.io/dagger/" target="_blank" rel="noopener noreferrer">dagger</a>.</p><p>I was facing the following problem : How to properly inject <code>Fragments</code> without the need to create a <code>DaggerComponent</code> for each of them ?</p><p>Providers are here to help. This is how I am doing</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class StepFragmentBL @Inject constructor() :</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Fragment(), Step, BlView {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var blPresenter: BlPresenter</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is one of the Fragment I am creating. We can see the <code>@Inject constructor</code> with <code>@Inject lateinit</code> var that shows that this object is injectable by dagger. It is also implementing <code>Step</code> to be used by <code>StepperLayout</code> and implements another interface.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class BlPresenter @Inject constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BlPresenter is a simple injectable class</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Singleton</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component(modules = [(DeliveryModule::class)])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">interface DeliveryComponents {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun inject(deliveryActivity: DeliveryActivity)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is the component injecting my Activity</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@Module</span></span><span class="token-line" style="color:#393A34"><span class="token plain">class DeliveryModule(private val activity: DeliveryActivity) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Named(&quot;Activity&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    internal fun providesContext(): Context {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return activity</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Provides</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun providesFragmentManager(): FragmentManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return activity.supportFragmentManager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class DeliveryActivity : AppCompatActivity() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var deliveryPresenter: DeliveryPresenter</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private lateinit var deliveryComponents: DeliveryComponents</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun onCreate(savedInstanceState: Bundle?) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.onCreate(savedInstanceState)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        setContentView(R.layout.activity_home)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        di()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ui()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private fun di() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        deliveryComponents = DaggerDeliveryComponents.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .deliveryModule(DeliveryModule(this))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        deliveryComponents.inject(this)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private fun ui() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Timber.v(Info.getMethodName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        stepperLayout.adapter = deliveryPresenter.stepperAdapter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We are creating the component into the <code>Activity</code> here. Then, presenter for this activity is also injected</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class DeliveryPresenter @Inject constructor() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var stepperAdapter: PickingStepperAdapter</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We are arriving to a <code>StepperAdapter</code> instance, also injected</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">private const val NB_FRAG = 2</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">class PickingStepperAdapter @Inject constructor(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        fm: FragmentManager,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Named(&quot;Activity&quot;) context: Context) :</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            AbstractFragmentStepAdapter(fm, context) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    * Provider for Fragment</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var blFragmentProvider: Provider&lt;StepFragmentBL&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    * Provider for Fragment</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var pdtFragmentProvider: Provider&lt;StepFragmentPdt&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun getCount(): Int {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NB_FRAG</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    override fun createStep(position: Int): Step {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Timber.v(&quot;${Info.getMethodName()} $position&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return when (position) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            0 -&gt; blFragmentProvider.get()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            else -&gt; pdtFragmentProvider.get()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here, we are just using</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@Inject</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var blFragmentProvider: Provider&lt;StepFragmentBL&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>to tell dagger to create the code that will provide an instance of fragment each time <code>blFragmentProvider.get()</code> will be called. Indeed, this is called here</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">return when (position) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            0 -&gt; blFragmentProvider.get()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            else -&gt; pdtFragmentProvider.get()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Like this, dagger is injecting fragment for us, and we don‚Äôt have to care about objects creation</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/from-pk8-to-jks">Android : Cr√©er un fichier keystore (jks) √† partir d‚Äôune cl√© (.pk8) et d‚Äôun certificat (.pem)</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2016-11-14T13:03:19.000Z" itemprop="datePublished">November 14, 2016</time> ¬∑ One min read</div></header><div class="markdown" itemprop="articleBody"><ul><li>Extraire la cl√© contenue dans le fichier pk8 et la mettre en clair dans un fichier pem</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">openssl pkcs8 -inform DER -nocrypt -in key.pk8 -out key.pem</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>Regrouper la cl√© et le certificat dans un fichier p12 temporaire</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">openssl pkcs12 -export -in certificate.pem -inkey key.pem -out platform.p12 -password pass:android -name AndroidDebugKey</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>G√©n√©rer le fichier jks √† partir du p12 (keytool est un outil du framework android)</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">keytool -importkeystore -deststorepass android -destkeystore platform.jks -srckeystore platform.p12 -srcstoretype PKCS12 -srcstorepass android</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>V√©rifier le fichier</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">keytool -list -v -keystore platform.jks</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/assignation-protect">Prot√©ger les classes contre la copie ou l‚Äôassignation en C++</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-08-14T13:02:46.000Z" itemprop="datePublished">August 14, 2014</time> ¬∑ One min read</div></header><div class="markdown" itemprop="articleBody"><p>Pour prot√©ger les classes contre la copie, il suffit de d√©clarer le constructeurs de copie en <code>private</code>. Une macro peut √™tre d√©finie car le principe est le m√™me pour toutes les classes.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">#define DECLARE_NO_COPY_CLASS(classname)  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private:                              </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        classname(const classname&amp;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>De m√™me pour les prot√©ger contre l‚Äôassignation, on peut d√©clarer la surcharge de l‚Äôop√©rateur <code>=</code> comme √©tant <code>private</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">#define DECLARE_NO_ASSIGN_CLASS(classname)  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private:                                </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        classname&amp; operator=(const classname&amp;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/static-assert">Assert Statique</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-08-04T13:02:57.000Z" itemprop="datePublished">August 4, 2014</time> ¬∑ One min read</div></header><div class="markdown" itemprop="articleBody"><p>L‚Äôutilisation d‚Äôun assert statique peut √™tre utile dans le cas ou une condition doit √™tre test√©e au moment de la compilation. Par exemple la taille d‚Äôun tableau. Le principe est d‚Äôutiliser une macro pour d√©finir une expression. Si le test est valide alors l‚Äôexpression g√©n√©r√©e l‚Äôest aussi, sinon elle r√©sulte en une erreur de compilation.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">#define STATIC_ASSERT(cond)    typedef int ERROR_##__LINE__[(cond) ? 1 : -1]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Ici, on utilise <code>typedef</code> pour d√©finir un type tableau. Si la condition est valide alors la taille du tableau est positive. Sinon elle est n√©gative ce qui r√©sulte en une erreur de compilation.</p><p>Exemple d‚Äôutilisation :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">STATIC_ASSERT(sizeof(object1) == sizeof(object2));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/mutex-locker">Mutex Locker</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-08-04T13:02:32.000Z" itemprop="datePublished">August 4, 2014</time> ¬∑ 2 min read</div></header><div class="markdown" itemprop="articleBody"><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="pr√©ambule"></a>Pr√©ambule<a class="hash-link" href="#pr√©ambule" title="Direct link to heading">#</a></h2><p>Le mutex locker fait partie du concept de <a href="http://fr.wikipedia.org/wiki/RAII" target="_blank" rel="noopener noreferrer">RAII</a>. Cette acronyme vient de l‚Äôanglais Resource Acquisition Is Initialization. C‚Äôest une technique de programmation qui permet de s‚Äôassurer que la ressource acquise sera bien lib√©r√©e √† la fin de la vie d‚Äôun objet.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="principe"></a>Principe<a class="hash-link" href="#principe" title="Direct link to heading">#</a></h2><p>Appliqu√© au mutex, ce principe consiste √† bloquer un mutex lors de la cr√©ation d‚Äôun objet et de le lib√©rer lors de sa destruction. On peut imaginer la cr√©ation d‚Äôun objet sp√©cifique : le <code>MutexLocker</code>.  Il faudrait qu‚Äôil puisse prendre un mutex lors de sa cr√©ation et le lib√©rer lors de sa destruction. Son constructeur va donc prendre le mutex et son destructeur le d√©truire.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">class MutexLocker {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public :</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MutexLocker(Mutex&amp; mutex): m_mutex(mutex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            m_mutex.Lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual ~MutexLocker(){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            m_mutex.Unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mutex&amp; m_mutex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Son utilisation proc√®de comme suit :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mutex mutex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MutexLocker locker(mutex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Maintenant le mutex est pris. Le code critique peut √™tre ex√©cut√©. */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>Son utilisation est justifi√© quand des exceptions peuvent arriver √† tout moment. A ce moment, le mutex est assur√© d‚Äô√™tre lib√©r√© √† la fin de la port√©e du code lorsque le locker est d√©truit. D‚Äôune mani√®re g√©n√©rale, il est bon de l‚Äôutiliser tout le temps pour √©viter de tomber dans des cas d‚Äôerreur difficiles √† d√©tecter.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/singleton">Singleton</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-08-04T13:02:16.000Z" itemprop="datePublished">August 4, 2014</time> ¬∑ 3 min read</div></header><div class="markdown" itemprop="articleBody"><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="pr√©sentation"></a>Pr√©sentation<a class="hash-link" href="#pr√©sentation" title="Direct link to heading">#</a></h2><p>Le singleton est un patron de conception (design pattern) dont le but est de restreindre l‚Äôinstanciation  d‚Äôune classe √† un nombre d√©fini d‚Äôobjets. Il est utilis√© lorsque l‚Äôon a besoin que d‚Äôun seul objet pour coordonner des actions dans un syst√®me. Par exemple, le singleton va √™tre utilis√© comme gestionnaire de fen√™tre, gestionnaire de syst√®mes de fichiers ou d‚Äôimprimantes. Le singleton va √™tre disponible de mani√®re globale dans un package et sera utilis√© comme √©tant un point d‚Äôacc√®s.</p><p>Le singleton est une classe qui va s‚Äôinstancier elle-m√™me. Ses constructeurs seront donc d√©finis comme √©tant priv√©s. Elle met √† disposition une m√©thode statique pour r√©cup√©rer son instance. Cette m√©thode v√©rifie qu‚Äôune seule instance existe ou en cr√©e une si elle n‚Äôexiste pas encore.</p><p>Une attention particuli√®re sera donn√©e dans les environnements multi-thread√©s. Si deux thread essaient d‚Äôacc√©der √† l‚Äôobjet, un seul devra l‚Äôinstancier tandis que le deuxi√®me obtiendra une r√©f√©rence sur l‚Äôobjet nouvellement cr√©√©.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="impl√©mentation-en-c"></a>Impl√©mentation en C++<a class="hash-link" href="#impl√©mentation-en-c" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">template &lt;typename T&gt; class Singleton</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* Get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(null == m_intance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                m_instance = new T;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual ~Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private :</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Les classes peuvent ensuite h√©riter de <code>Singleton</code>. Elles seront instanci√©es par la m√©thode h√©rit√©e <code>Get()</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">lass Eur : public Singleton&lt;Eur&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    friend class Singleton&lt;Eur&gt;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">func(){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Eur* obj = Eur::Get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="multi-threading"></a>Multi-Threading<a class="hash-link" href="#multi-threading" title="Direct link to heading">#</a></h2><p>Dans un environnement multi-t√¢che,  il est important de prot√©ger le code d‚Äôinstanciation pour √©viter d‚Äôavoir plusieurs r√©f√©rences vers le Singleton lorsque celui-ci est appel√© depuis plusieurs threads diff√©rents.</p><p>La solution peut √™tre comme suit :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">template &lt;typename T&gt; class Singleton</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* Get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            m_mutex.Lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(null == m_intance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                m_instance = new T;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            m_mutex.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual ~Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private :</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static Mutex m_mutex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Ici <code>Mutex</code> est une classe qui initialise le mutex dans son constructeur par d√©faut et pr√©sente les m√©thodes <code>Lock()</code> et <code>Unlock()</code> pour locker et d√©locker le mutex.</p><p>Le probl√®me de cette solution est que le mutex est lock√© √† chaque appel de <code>Get()</code>. Ceci peut √™tre co√ªteux en nombre d‚Äôinstruction en comparaison avec un simple test pour savoir si m_instance existe. D‚Äôautant plus que le Singleton n‚Äôest instanci√© qu‚Äôune seule fois pendant la dur√©e de vie du programme.</p><p>Une proposition d‚Äôoptimisation serait de tester une premi√®re fois si l‚Äôinstance existe sans locker le mutex puis de tester une seconde fois sous protection dans le cas ou l‚Äôinstance n‚Äôexiste pas. Ceci ajoute un test dans le cas ou l‚Äôinstance n‚Äôexiste pas, mais enl√®ve tout appel au mutex dans le cas ou elle existe.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">template &lt;typename T&gt; class Singleton</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* Get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(null == instance)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                m_mutex.Lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if(null == m_intance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    m_instance = new T;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                m_mutex.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        virtual ~Singleton(){};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private :</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static T* m_instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        static Mutex m_mutex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Cette solution est valide car les acc√®s concurrents en lecture ne sont pas p√©nalisant. En effet, le <code>Singleton</code> est le m√™me pour tous les threads.</p></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/page/2"><div class="pagination-nav__label">Older Entries ¬ª</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/treessence/index">Treessence</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/countries/index">AndroidCountries</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/users/1442734/bipi" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/bastienpaulfr" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 Bastien PAUL, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fde905a3.js"></script>
<script src="/assets/js/main.d015e873.js"></script>
</body>
</html>